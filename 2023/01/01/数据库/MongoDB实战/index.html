<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MongoDB 实战 | Simon 的书柜</title><meta name="author" content="Simon"><meta name="copyright" content="Simon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MongoDB 实战简介什么是 MongoDBMongoDB 是一个文档数据库（以 JSON 为数据模型），由 C++ 编写，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。文档指的是 “JSON Document”，并非一般我们理解的 Word、PDF 等文档 MongoDB 是一个介于关系型数据库和非关系型数据库之间的产品，是非关系型数据库中功能最丰富、最像关系型数据库的。它支持的数据">
<meta property="og:type" content="article">
<meta property="og:title" content="MongoDB 实战">
<meta property="og:url" content="http://yoursite.com/2023/01/01/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="Simon 的书柜">
<meta property="og:description" content="MongoDB 实战简介什么是 MongoDBMongoDB 是一个文档数据库（以 JSON 为数据模型），由 C++ 编写，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。文档指的是 “JSON Document”，并非一般我们理解的 Word、PDF 等文档 MongoDB 是一个介于关系型数据库和非关系型数据库之间的产品，是非关系型数据库中功能最丰富、最像关系型数据库的。它支持的数据">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%20%E5%AE%9E%E6%88%98/preview.jpg">
<meta property="article:published_time" content="2023-01-01T14:49:47.000Z">
<meta property="article:modified_time" content="2024-06-08T04:13:07.151Z">
<meta property="article:author" content="Simon">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="MongoDB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%20%E5%AE%9E%E6%88%98/preview.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2023/01/01/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%E5%AE%9E%E6%88%98/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MongoDB 实战',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-08 12:13:07'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E8%83%8C%E6%99%AF%E5%9B%BE/v2-bd12bc8dfb61abe313ad48b907c5da94_720w.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%20%E5%AE%9E%E6%88%98/preview.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Simon 的书柜"><span class="site-name">Simon 的书柜</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MongoDB 实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-01T14:49:47.000Z" title="发表于 2023-01-01 22:49:47">2023-01-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-08T04:13:07.151Z" title="更新于 2024-06-08 12:13:07">2024-06-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MongoDB 实战"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="MongoDB-实战"><a href="#MongoDB-实战" class="headerlink" title="MongoDB 实战"></a>MongoDB 实战</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><h4 id="什么是-MongoDB"><a href="#什么是-MongoDB" class="headerlink" title="什么是 MongoDB"></a>什么是 MongoDB</h4><p>MongoDB 是一个文档数据库（以 JSON 为数据模型），由 C++ 编写，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。文档指的是 “JSON Document”，并非一般我们理解的 Word、PDF 等文档</p>
<p>MongoDB 是一个介于关系型数据库和非关系型数据库之间的产品，是非关系型数据库中功能最丰富、最像关系型数据库的。它支持的数据结构非常松散，数据格式是 BSON，一种类似于 JSON 的二进制存储格式，简称 Binary JSON，和 JSON 一样支持内嵌的文档对象和数组对象，因此可以存储比较复杂的数据结构。MongoDB 最大的特点是它支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系型数据库单表查询的绝大部分功能，而且还支持对数据建立索引。原则上 MySQL 和 Oracle 能做的事，MongoDB 都能做，包括 ACID 事务</p>
<p>MongoDB 在数据库最排名中排第 5，仅次于 Oracle、MySQL 等 RDBMS，在 NoSQL 数据库中排在首位，自诞生依赖，其项目应用广度、社区活跃度指数持续上升</p>
<p>MongoDB 概念与 RDBMS 概念非常类似</p>
<table>
<thead>
<tr>
<th align="center">SQL 概念</th>
<th align="center">MongoDB 概念</th>
</tr>
</thead>
<tbody><tr>
<td align="center">数据库（database）</td>
<td align="center">数据库（database）</td>
</tr>
<tr>
<td align="center">表（table）</td>
<td align="center">集合（collection）</td>
</tr>
<tr>
<td align="center">行（row）</td>
<td align="center">文档（document）</td>
</tr>
<tr>
<td align="center">列（column）</td>
<td align="center">字段（field）</td>
</tr>
<tr>
<td align="center">索引（index）</td>
<td align="center">索引（index）</td>
</tr>
<tr>
<td align="center">主键（primary key）</td>
<td align="center">主键（_id）</td>
</tr>
<tr>
<td align="center">视图（view）</td>
<td align="center">视图（view）</td>
</tr>
<tr>
<td align="center">表连接（table join）</td>
<td align="center">聚合操作（￥lookup）</td>
</tr>
</tbody></table>
<p>尽管这些概念与 SQL 标准定义类似，但 MongoDB 与传统 RDBMS 仍存在不少差异：</p>
<ul>
<li>半结构化，在一个集合中，文档所拥有的字段并不需要是相同的，而且不需要对所用字段进行声明。因此，MongoDB 具有很明显的半结构化的特点。除了松散的表结构，文档还可以支持多级的嵌套、数组等灵活的数据类型，非常契合面向对象的编程模型</li>
<li>弱关系，MongoDB 没有外键的约束，也没有非常强大的表连接能力，类似的功能需要聚合管道技术来补充</li>
</ul>
<hr>
<h4 id="技术优势"><a href="#技术优势" class="headerlink" title="技术优势"></a>技术优势</h4><p>MongoDB 基于灵活的 JSON 文档模型，非常适合敏捷式的快速开发。与此同时，其越生俱来的高可用、高水平扩展能力使得它在处理海量、高并发的数据应用时颇有优势</p>
<ul>
<li>JSON 结构对象与对象模型接近，开发代码量低</li>
<li>JSON 的动态模型意味着更容易响应新的业务需求</li>
<li>复制集提供 99.99% 的高可用</li>
<li>分片架构支持海量数据和无限扩容</li>
</ul>
<hr>
<h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><p>从目前阿里云 MongoDB 云数据库上的用户看，MongoDB 的应用已经渗透到了各个领域</p>
<ul>
<li>游戏场景，使用 MongoDB 存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式储存，方便查询、更新</li>
<li>物流场景，使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以 MongoDB 内嵌数组的形式来储存，一次查询就能将订单所有的变更读取出来</li>
<li>社交场景，使用 MongoDB 存储用户信息，以及用户发表的朋友圈信息，通过地理位置搜索实现附近的人、地点等功能</li>
<li>物联网场景，使用 MongoDB 存储所有接入的只能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析</li>
<li>视频直播，使用 MongoDB 存储用户信息、礼物信息等</li>
<li>大数据应用，使用云数据库 MongoDB 作为大数据的云存储系统，即时进行数据提取分析</li>
</ul>
<hr>
<h3 id="Mongo-Shell"><a href="#Mongo-Shell" class="headerlink" title="Mongo Shell"></a>Mongo Shell</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>Mongo Shell 是 MongoDB 的交互式 JavaScript Shell 界面，它为系统管理员提供了强大的界面，并为开发人员提供了直接操作数据库的方法</p>
<hr>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">show dbs | show databases</td>
<td align="center">显示数据库列表</td>
</tr>
<tr>
<td align="center">use 数据库名</td>
<td align="center">切换数据库，如果不存在则创建</td>
</tr>
<tr>
<td align="center">db.dropDatabase()</td>
<td align="center">删除数据库</td>
</tr>
<tr>
<td align="center">show collections | show tables</td>
<td align="center">显示当前的数据库集合列表</td>
</tr>
<tr>
<td align="center">db.集合名.stats()</td>
<td align="center">查看集合详情</td>
</tr>
<tr>
<td align="center">db.集合名.drop()</td>
<td align="center">删除集合</td>
</tr>
<tr>
<td align="center">show users</td>
<td align="center">显示当前数据库的用户列表</td>
</tr>
<tr>
<td align="center">show roles</td>
<td align="center">显示当前数据库的角色列表</td>
</tr>
<tr>
<td align="center">show profile</td>
<td align="center">显示最近发生的操作</td>
</tr>
<tr>
<td align="center">load(“XXX.js”)</td>
<td align="center">执行一个 JS 脚本文件</td>
</tr>
<tr>
<td align="center">exit | quit()</td>
<td align="center">退出当前 shell</td>
</tr>
<tr>
<td align="center">db.version()</td>
<td align="center">查看数据库版本</td>
</tr>
</tbody></table>
<hr>
<h4 id="创建管理员账号"><a href="#创建管理员账号" class="headerlink" title="创建管理员账号"></a>创建管理员账号</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置管理员用户名密码需要切换到 admin 库</span></span><br><span class="line">use admin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建管理员</span></span><br><span class="line">db.createUser(&#123;user:&quot;admin&quot;,pwd:&quot;admin&quot;,roles:[&quot;root&quot;]&#125;)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有用户信息</span></span><br><span class="line">show users</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除用户</span></span><br><span class="line">db.dropUser(&quot;admin&quot;)</span><br></pre></td></tr></table></figure>



<p>mongodb内置角色：</p>
<pre><code>1. 数据库用户角色：read、readWrite
2. 数据库管理角色：dbAdmin、dbOwner、userAdmin
3. 集群管理角色：clusterAdmin、clusterManager、clusterMonitor、hostManager
4. 备份恢复角色：backup、restore
5. 所有数据库角色：readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、dbAdminAnyDatabase
6. 超级用户角色：root  
7. 内部角色：__system
</code></pre>
<hr>
<h4 id="创建应用数据库用户"><a href="#创建应用数据库用户" class="headerlink" title="创建应用数据库用户"></a>创建应用数据库用户</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use testdb</span><br><span class="line">db.createUser(&#123;user:<span class="string">&quot;admin&quot;</span>,<span class="built_in">pwd</span>:<span class="string">&quot;admin&quot;</span>,roles:[<span class="string">&quot;dbOwner&quot;</span>]&#125;)</span><br></pre></td></tr></table></figure>



<p>默认情况下，MongoDB 不会启用鉴权，以鉴权模式启动 MongoDB</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /mongodb/conf/mongo.conf --auth</span><br></pre></td></tr></table></figure>

<p>启用鉴权模式后，连接 MongoDB 的相关操作都需要提供身份认证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo localhost:27017 -u admin -p admin -authenticationDatabase=admin</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h3><h4 id="创建集合"><a href="#创建集合" class="headerlink" title="创建集合"></a>创建集合</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(name, options)</span><br></pre></td></tr></table></figure>

<p>name 是要创建的集合的名称，options 是可选参数, 指定有关内存大小及索引的选项，可以是如下参数：</p>
<table>
<thead>
<tr>
<th align="center">字段</th>
<th align="center">类型</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">capped</td>
<td align="center">布尔</td>
<td align="center">（可选）如果为 true，则创建固定集合。固定集合是指有着固定大小的集合，当达到最大值时，它会自动覆盖最早的文档。当该值为 true 时，必须指定 size 参数</td>
</tr>
<tr>
<td align="center">autoIndexId</td>
<td align="center">布尔</td>
<td align="center">3.2 之后不再支持该参数。（可选）如为 true，自动在 _id 字段创建索引。默认为 false</td>
</tr>
<tr>
<td align="center">size</td>
<td align="center">数值</td>
<td align="center">（可选）为固定集合指定一个最大值，即字节数。如果 capped 为 true，也需要指定该字段</td>
</tr>
<tr>
<td align="center">max</td>
<td align="center">数值</td>
<td align="center">（可选）指定固定集合中包含文档的最大数量</td>
</tr>
</tbody></table>
<p>‘</p>
<p>示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(&quot;mycol&quot;, &#123; capped : true, autoIndexId : true, size : 6142800, max : 10000 &#125; )</span><br></pre></td></tr></table></figure>

<p>在 MongoDB 中，你不需要创建集合。当你插入一些文档时，MongoDB 会自动创建集合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 如果 mycol2 集合不存在，则会自动创建</span><br><span class="line">db.mycol2.insert(&#123;&quot;name&quot; : &quot;simon&quot;&#125;)</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.drop()</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h3><h4 id="新增文档"><a href="#新增文档" class="headerlink" title="新增文档"></a>新增文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insert()</span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// document  要插入集合的文件</span></span><br><span class="line"><span class="comment">// writeConcern 可选参数，设置副本集同步数量，等待时间等内容</span></span><br><span class="line"><span class="comment">// ordered 是否按顺序插入，默认为 true</span></span><br><span class="line">db.<span class="property">collection</span>.<span class="title function_">insert</span>(</span><br><span class="line">   &lt;document or array of documents&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     writeConcern: &lt;document&gt;,</span><br><span class="line">     ordered: &lt;boolean&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<p>例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">products</span>.<span class="title function_">insertOne</span>( &#123; <span class="attr">_id</span>: <span class="number">10</span>, <span class="attr">item</span>: <span class="string">&quot;box&quot;</span>, <span class="attr">qty</span>: <span class="number">20</span> &#125; );</span><br></pre></td></tr></table></figure>

<p>如果没有输入 _id 参数，MongoDB 会自动为数据生成一个 id，如果输入的 id 已经存在，则会抛出异常</p>
<p>参数内容也可以是个数组，即批量新增文档</p>
<p>3.2 版本之后新增了 db.collection.insertOne() 和 db.collection.insertMany() 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">collection</span>.<span class="title function_">insertOne</span>(</span><br><span class="line">   &lt;<span class="variable language_">document</span>&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="attr">writeConcern</span>: &lt;<span class="variable language_">document</span>&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db.<span class="property">collection</span>.<span class="title function_">insertMany</span>(</span><br><span class="line">   [ &lt;document 1&gt; , &lt;document 2&gt;, ... ],</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;,</span><br><span class="line">      ordered: &lt;boolean&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// 更新单个文档</span><br><span class="line">db.collection.updateOne(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &lt;update&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     upsert: &lt;boolean&gt;,</span><br><span class="line">     writeConcern: &lt;document&gt;,</span><br><span class="line">     collation: &lt;document&gt;,</span><br><span class="line">     arrayFilters: [ &lt;filterdocument1&gt;, ... ],</span><br><span class="line">     hint:  &lt;document|string&gt;        // Available starting in MongoDB 4.2.1</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 更新多个文档</span><br><span class="line">db.collection.updateMany(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &lt;update&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     upsert: &lt;boolean&gt;,</span><br><span class="line">     writeConcern: &lt;document&gt;,</span><br><span class="line">     collation: &lt;document&gt;,</span><br><span class="line">     arrayFilters: [ &lt;filterdocument1&gt;, ... ],</span><br><span class="line">     hint:  &lt;document|string&gt;        // Available starting in MongoDB 4.2.1</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 替换单个文档</span><br><span class="line">db.collection.replaceOne(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &lt;replacement&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     upsert: &lt;boolean&gt;,</span><br><span class="line">     writeConcern: &lt;document&gt;,</span><br><span class="line">     collation: &lt;document&gt;,</span><br><span class="line">     hint: &lt;document|string&gt;                   // Available starting in 4.2.1</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<ul>
<li>filter：更新的条件</li>
<li>update 或 replacement：更新或替换的内容</li>
<li>upset：如果不存在要更新的内容是否新增，默认为 false</li>
<li>writeConcern：可选，抛出异常的级别</li>
<li>collation：排序规则</li>
<li>hint：可以用于指定 filter 索引</li>
</ul>
<p>比如，将用户名为 Simon 的用户 age 改为 18</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.restaurant.updateOne(</span><br><span class="line">  &#123; &quot;name&quot; : &quot;Simon&quot; &#125;,</span><br><span class="line">  &#123; $set: &#123; &quot;age&quot; : 18 &#125; &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<p>$set 是要进行操作的操作符，常用的操作符如下</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>格式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>$set</td>
<td>{ $set : { filed : value }}</td>
<td>指定一个键并更新，如果不存在则新建</td>
</tr>
<tr>
<td>$unset</td>
<td>{ $unset : { filed : 1}}</td>
<td>删除一个键</td>
</tr>
<tr>
<td>$inc</td>
<td>{ $inc : { filed : value }}</td>
<td>对数值进行增减</td>
</tr>
<tr>
<td>$rename</td>
<td>{ $rename : { old_name: new_name}}</td>
<td>修改字段名称</td>
</tr>
<tr>
<td>$push</td>
<td>{ $push : { filed : value }}</td>
<td>将数值追加到数组中，如果数组不存在则初始化</td>
</tr>
<tr>
<td>$pushAll</td>
<td>{ $pushAll : { filed : value_array }}</td>
<td>将多个值追加到数组中</td>
</tr>
<tr>
<td>$pull</td>
<td>{ $set : { filed : value }}</td>
<td>从数组中删除指定元素</td>
</tr>
<tr>
<td>$addToSet</td>
<td>{ $addToSet : { filed : value }}</td>
<td>添加元素到数组中，具有排重功能</td>
</tr>
<tr>
<td>$pop</td>
<td>{ $pop : { filed : 1}}</td>
<td>删除第一个或最后一个元素</td>
</tr>
</tbody></table>
<hr>
<h4 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query, projection)</span><br></pre></td></tr></table></figure>

<ul>
<li>query 可选，使用查询操作符指定查询条件</li>
<li>projection 可选，使用投影操作符指定返回的键。查询时返回文档中所有键值， 只需省略该参数即可（默认省略）</li>
</ul>
<p>返回文档中所有 status 为 A 的文档，返回所有字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; status: &quot;A&quot; &#125; )</span><br></pre></td></tr></table></figure>

<p>返回文档中所有 status 为 A 的文档，返回 item、status、id 3 个字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; status: &quot;A&quot; &#125;, &#123; item: 1, status: 1 &#125; )</span><br></pre></td></tr></table></figure>

<p>id 字段是默认返回的，如果不想要 id 字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; status: &quot;A&quot; &#125;, &#123; item: 1, status: 1, _id: 0 &#125; )</span><br></pre></td></tr></table></figure>

<p>返回文档中所有 status 为 A 的文档，返回除了 status 之外的所有字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; status: &quot;A&quot; &#125;, &#123; status: 0 &#125; )</span><br></pre></td></tr></table></figure>

<p>返回嵌套文档中的指定字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find(</span><br><span class="line">   &#123; status: &quot;A&quot; &#125;,</span><br><span class="line">   &#123; item: 1, status: 1, &quot;size.uom&quot;: 1 &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>如果想检索数组中包含red、blank两个元素并且不在乎元素顺序或者数组中是否有其它元素。可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; tags: &#123; $all: [&quot;red&quot;, &quot;blank&quot;] &#125; &#125; )</span><br></pre></td></tr></table></figure>

<p>返回 inventory 集合中数组字段 tags 中有一个元素的值 red 的所有文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; tags: &quot;red&quot; &#125; )</span><br></pre></td></tr></table></figure>

<p>返回 inventory 集合中数组字段 dim_cm 中最少有一个元素的值大于 25的所有文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; dim_cm: &#123; $gt: 25 &#125; &#125; )</span><br></pre></td></tr></table></figure>

<p>返回 inventory 集合中数组字段 dim_cm 中单个元素同时满足大于 15 并且小于 20，或者一个元素满足大于 15，另外一个元素小于 20 的所有文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; dim_cm: &#123; $gt: 15, $lt: 20 &#125; &#125; )</span><br></pre></td></tr></table></figure>

<p>返回的是 item 字段值为 null 的文档或者不包含 item 字段的文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; item: null &#125; )</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 删除单个文档</span><br><span class="line">db.collection.deleteOne(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;,</span><br><span class="line">      collation: &lt;document&gt;,</span><br><span class="line">      hint: &lt;document|string&gt;        // Available starting in MongoDB 4.4</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 删除多个文档</span><br><span class="line">db.collection.deleteMany(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">      writeConcern: &lt;document&gt;,</span><br><span class="line">      collation: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="SpringBoot-整合"><a href="#SpringBoot-整合" class="headerlink" title="SpringBoot 整合"></a>SpringBoot 整合</h3><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://username:password@ip:port/database?authSource=admin</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注入操作对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Resoure</span><br><span class="line">private MongoTemplate mongoTemplate;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">// 表示 user 集合中的一个文档</span></span><br><span class="line"><span class="meta">@Document(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 指定文档 id</span></span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 指定字段</span></span><br><span class="line">	<span class="meta">@Field(&quot;username&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 表示该字段不参与序列化</span></span><br><span class="line">	<span class="meta">@Transient</span></span><br><span class="line">	<span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h4 id="添加文档"><a href="#添加文档" class="headerlink" title="添加文档"></a>添加文档</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">user.setName(<span class="string">&quot;Simon&quot;</span>);</span><br><span class="line"><span class="comment">// id 不存在则插入，id 存在则更新</span></span><br><span class="line">mongoTemplate.save(user);</span><br><span class="line"><span class="comment">// id 存在则抛出异常，支持批量操作</span></span><br><span class="line">mongoTemplate.insert(user);</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="查询文档-1"><a href="#查询文档-1" class="headerlink" title="查询文档"></a>查询文档</h4><p>Criteria 是标准查询的接口，可以引用静态的 Criteria.where 把多个条件组合在一起，就可以将多个方法和查询条件连接起来，方便我们操作查询语句</p>
<table>
<thead>
<tr>
<th align="center">Criteria</th>
<th align="center">MongoDB</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Criteria and(String key)</td>
<td align="center">$and</td>
<td align="center">且</td>
</tr>
<tr>
<td align="center">Criteria andOperator(Criteria … criteria)</td>
<td align="center">$and</td>
<td align="center">且</td>
</tr>
<tr>
<td align="center">Criteria orOperator(Criteria … criteria)</td>
<td align="center">$or</td>
<td align="center">或</td>
</tr>
<tr>
<td align="center">Criteria gt(Obejct o)</td>
<td align="center">$gt</td>
<td align="center">大于</td>
</tr>
<tr>
<td align="center">Criteria gte(Obejct o)</td>
<td align="center">$gte</td>
<td align="center">大于等于</td>
</tr>
<tr>
<td align="center">Criteria in(Obejct … o)</td>
<td align="center">$in</td>
<td align="center">包含</td>
</tr>
<tr>
<td align="center">Criteria is(Obejct o)</td>
<td align="center">$is</td>
<td align="center">等于</td>
</tr>
<tr>
<td align="center">Criteria lt(Obejct o)</td>
<td align="center">$lt</td>
<td align="center">小于</td>
</tr>
<tr>
<td align="center">Criteria lte(Obejct o)</td>
<td align="center">$lte</td>
<td align="center">小于等于</td>
</tr>
<tr>
<td align="center">Criteria nin(Obejct … o)</td>
<td align="center">$nin</td>
<td align="center">不包含</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// 查询所有文档</span></span><br><span class="line">	List&lt;UserVO&gt; users = mongoTemplate.findAll(UserVO.class);</span><br><span class="line">	users.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据 id 查询</span></span><br><span class="line">	<span class="type">UserVO</span> <span class="variable">user</span> <span class="operator">=</span> mongoTemplate.findById(<span class="number">1</span>, UserVO.class);</span><br><span class="line">	System.out.println(user);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回第一个文档</span></span><br><span class="line">	<span class="type">UserVO</span> <span class="variable">one</span> <span class="operator">=</span> mongoTemplate.findOne(<span class="keyword">new</span> <span class="title class_">Query</span>(), UserVO.class);</span><br><span class="line">	System.out.println(one);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 多条件查询，查询姓年纪大于 18 小于 40 的文档</span></span><br><span class="line">	<span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;age&quot;</span>).gt(<span class="number">18</span>).lt(<span class="number">40</span>));</span><br><span class="line">	List&lt;UserVO&gt; users = mongoTemplate.find(query, UserVO.class);</span><br><span class="line">	<span class="comment">// 模糊查询，java 中正则不需要 //</span></span><br><span class="line">	<span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;name&quot;</span>).regex(<span class="string">&quot;陈&quot;</span>));</span><br><span class="line">	List&lt;UserVO&gt; users = mongoTemplate.find(query, UserVO.class);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// and or 多条件查询</span></span><br><span class="line">	<span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Criteria</span>();</span><br><span class="line">	criteria.andOperator(Criteria.where(<span class="string">&quot;name&quot;</span>).is(<span class="string">&quot;Simon&quot;</span>), Criteria.where(<span class="string">&quot;age&quot;</span>).gt(<span class="number">18</span>));</span><br><span class="line">	criteria.orOperator(Criteria.where(<span class="string">&quot;name&quot;</span>).is(<span class="string">&quot;Simon&quot;</span>), Criteria.where(<span class="string">&quot;age&quot;</span>).gt(<span class="number">18</span>));</span><br><span class="line">	<span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// sort 排序</span></span><br><span class="line">	query.with(Sort.by(Sort.Order.desc(<span class="string">&quot;age&quot;</span>)));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 分页</span></span><br><span class="line">	query</span><br><span class="line">		<span class="comment">// 指定跳过的记录数</span></span><br><span class="line">		.skip(<span class="number">0</span>)</span><br><span class="line">		<span class="comment">// 每页显示的数量</span></span><br><span class="line">		.limit(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 也可以直接手写 Mongo sql 查询</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;&#123;$or: [&#123;age:&#123;$lt:25&#125;&#125;, &#123;age:&#123;$gt:40&#125;&#125;]&#125;&quot;</span>;</span><br><span class="line">	<span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicQuery</span>(sql);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="更新文档-1"><a href="#更新文档-1" class="headerlink" title="更新文档"></a>更新文档</h4><p>在 MongoDB 中无论使用客户端 API 还是使用 Spring Data，更新返回结果一定是受影响行数。如果没有数据需要进行更新则返回 0</p>
<ul>
<li>updateFirst() 只更新满足条件的第一条记录</li>
<li>updateMulti() 更新所有满足条件的记录</li>
<li>upsert() 没有满足更新条件的数据则新增</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// 设置更新条件</span></span><br><span class="line">	<span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;age&quot;</span>).gt(<span class="number">18</span>).lt(<span class="number">40</span>));</span><br><span class="line">    <span class="comment">// 设置需要更新的内容</span></span><br><span class="line">    <span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">    update.set(<span class="string">&quot;phone&quot;</span>, <span class="string">&quot;123123&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">UpdateResult</span> <span class="variable">result</span> <span class="operator">=</span> mongoTemplate.updateFirst(query, update, UserVO.class);</span><br><span class="line">    <span class="type">UpdateResult</span> <span class="variable">result</span> <span class="operator">=</span> mongoTemplate.updateMulti(query, update, UserVO.class);</span><br><span class="line">    <span class="type">UpdateResult</span> <span class="variable">result</span> <span class="operator">=</span> mongoTemplate.upsert(query, update, UserVO.class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回修改的记录数</span></span><br><span class="line">    System.out.println(result.getModifiedCouunt());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="删除文档-1"><a href="#删除文档-1" class="headerlink" title="删除文档"></a>删除文档</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// 删除所有文档</span></span><br><span class="line">	mongoTemplate.remove(<span class="keyword">new</span> <span class="title class_">Query</span>(), UserVO.class);</span><br><span class="line">    <span class="comment">// 删除满足条件的文档</span></span><br><span class="line">	mongoTemplate.remove(<span class="keyword">new</span> <span class="title class_">Query</span>((Criteria.where(<span class="string">&quot;id&quot;</span>).is(<span class="number">18</span>)), UserVO.class);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="聚合操作"><a href="#聚合操作" class="headerlink" title="聚合操作"></a>聚合操作</h3><h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><p>聚合操作处理数据并返回结果（比如平均值、求和等）。聚合操作组值来自多个文档，可以对分组数组执行各种操作以返回单个结果。聚合操作包含三类：单一作用聚合、聚合管道、MapReduce</p>
<ul>
<li>单一作用聚合：提供了对常见聚合过程的简单访问，操作从单个集合聚合文档</li>
<li>聚合管道：数据聚合的框架，模型基于数据处理流水线的概念，文档进入多级管道，将文档转换为聚合结果</li>
<li>MapReduce：MapReduce 操作具有两个阶段，一阶段处理文档输出一个或多个结果，二阶段组合 Map 输出聚合结果</li>
</ul>
<hr>
<h4 id="单一聚合操作"><a href="#单一聚合操作" class="headerlink" title="单一聚合操作"></a>单一聚合操作</h4><p>MongoDB 提供了 count()、distinctCount() 这类单一作用的聚合函数，所有的操作都聚合来自单个集合的文档，虽然这些操作提供了对公共聚合过程的简单访问，但它缺乏聚合管道和 MapReduce 的灵活性和功能</p>
<p>MongoDB 中聚合的方法使用 aggregate()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.aggregate(AGGREGATE_OPERATION)</span><br></pre></td></tr></table></figure>

<p>比如计算每个年龄的人数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.aggregate([&#123;$group : &#123;_id : &quot;$age&quot;, num_tutorial : &#123;$sum : 1&#125;&#125;&#125;])</span><br></pre></td></tr></table></figure>



<p>一些常用的聚合表达式</p>
<table>
<thead>
<tr>
<th align="center">表达式</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$sum</td>
<td align="center">计算总和</td>
</tr>
<tr>
<td align="center">$avg</td>
<td align="center">计算平均值</td>
</tr>
<tr>
<td align="center">$min</td>
<td align="center">获取集合中所有文档对应值得最小值</td>
</tr>
<tr>
<td align="center">$max</td>
<td align="center">获取集合中所有文档对应值得最大值</td>
</tr>
<tr>
<td align="center">$push</td>
<td align="center">将值加入一个数组中，不会判断是否有重复的值</td>
</tr>
<tr>
<td align="center">$addToSet</td>
<td align="center">将值加入一个数组中，会判断是否有重复的值，若相同的值在数组中已经存在了，则不加入</td>
</tr>
<tr>
<td align="center">$first</td>
<td align="center">根据资源文档的排序获取第一个文档数据</td>
</tr>
<tr>
<td align="center">$last</td>
<td align="center">根据资源文档的排序获取最后一个文档数据</td>
</tr>
</tbody></table>
<hr>
<h4 id="聚合管道"><a href="#聚合管道" class="headerlink" title="聚合管道"></a>聚合管道</h4><p>管道在 Unix 和 Linux 中一般用于将当前命令的输出结果作为下一个命令的参数</p>
<p>MongoDB 的聚合管道将 MongoDB 文档在一个管道处理完毕后将结果传递给下一个管道处理。管道操作是可以重复的</p>
<p>聚合管道操作语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pipeline = [$stage1, $stage2, ... $stageN]</span><br><span class="line">db.collection.aggregate(pipeline, &#123;options&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>pipeline：数据聚合阶段，除 $out、$merge 和 $geonear 外，每个阶段可以在管道中出现多次</li>
<li>options：其它参数，包括查询计划，是否使用临时文件、游标、最大操作时间、读写策略、强制索引等等</li>
</ul>
<p>常用聚合阶段</p>
<table>
<thead>
<tr>
<th align="center">阶段</th>
<th align="center">描述</th>
<th align="center">SQL 等价</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$match</td>
<td align="center">用于过滤数据，只输出符合条件的文档</td>
<td align="center">WHERE</td>
</tr>
<tr>
<td align="center">$project</td>
<td align="center">修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档</td>
<td align="center">AS</td>
</tr>
<tr>
<td align="center">$lookup</td>
<td align="center">左外连接</td>
<td align="center">LEFT OUTER JOIN</td>
</tr>
<tr>
<td align="center">$sort</td>
<td align="center">排序</td>
<td align="center">ORDER BY</td>
</tr>
<tr>
<td align="center">$group</td>
<td align="center">分组</td>
<td align="center">GROUP BY</td>
</tr>
<tr>
<td align="center">$skip&#x2F;$limit</td>
<td align="center">分页参数</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">$unwind</td>
<td align="center">将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">$graphLookup</td>
<td align="center">图搜索</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">$facet&#x2F;$bucket</td>
<td align="center">分面搜索</td>
<td align="center"></td>
</tr>
</tbody></table>
<ul>
<li><p>$project</p>
<p>投影操作，将原始字段投影成指定名称，比如将集合中的 name 投影成 username</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.aggregate([&#123;$project:&#123;username:&quot;$name&quot;&#125;&#125;]);</span><br></pre></td></tr></table></figure>

<p>$project 可以灵活控制输出文档的格式，可以剔除不需要的字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.aggregate([&#123;$project:&#123;_id:0, name:1&#125;&#125;])</span><br></pre></td></tr></table></figure>
</li>
<li><p>$match</p>
<p>$match 用于对文档进行筛选，之后可以在得到的子文档上进行聚合，$match 可以使用除了地理空间之外的所有的常规查询操作符。在实际开发中尽量将 $match 放在管道前面的位置，这样做有两个好处，一是可以快速将不需要的文档过滤掉，减少管道的工作量，二是如果在投射和分组之前执行 $match，查询可以使用索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.aggregate([&#123;$match:&#123;name:&quot;Simon&quot;&#125;&#125;])</span><br></pre></td></tr></table></figure>
</li>
<li><p>$count</p>
<p>计数并返回与结果匹配的数量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.aggregate([&#123;$match:&#123;name:&quot;Simon&quot;&#125;, &#123;$count:&quot;name_count&quot;&#125;])</span><br></pre></td></tr></table></figure>
</li>
<li><p>$group</p>
<p>按指定的表达式对文档进行分组，并将每个不同分组的文档输出到下一阶段。输出文档包含一个 id 字段，该字段按键包含不同的组。输出文档还可以包含计算字段，该字段保存由 $group 的 _id 字段分组的一些 accumulator 表达式的值。$group 不会输出具体的文档而是统计信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;$group:&#123;_id:&lt;expression&gt;, &lt;field&gt;:&#123;&lt;accumulator1&gt;:&lt;expression1&gt;&#125;, ...&#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>id 字段是必填的，可以指定 id 值为 null 来为整个文档计算累计值</li>
<li>剩余的计算字段是可选的，并使用 accumulator 运算符进行计算</li>
<li>id 和 accumulator 表示式可以接收任何有效的表达式</li>
</ul>
</li>
<li><p>$limit</p>
<p>限制管道传到下一阶段的文档数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.aggregate([&#123;$limit:5&#125;])</span><br></pre></td></tr></table></figure>

<p>$sort 无论是在 $limit 之前还是之后出现，$sort 都只会在过程中维持前 N 个结果，其中 N 是指定的限制，MongoDB 只需将前 N 项内容存储在内存中</p>
</li>
<li><p>$skip</p>
<p>跳过指定数量的文档，并将其余文档传递到下一阶段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.aggregate([&#123;$skip:5&#125;])</span><br></pre></td></tr></table></figure>
</li>
<li><p>$sort</p>
<p>对所有输入文档进行排序，并按照顺序将他们返回到管道</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.aggregate([&#123;$sort:&#123;age:-1, name:1&#125;&#125;])</span><br></pre></td></tr></table></figure>

<p>其中 1 代表升序，-1 代表降序</p>
</li>
</ul>
<hr>
<h4 id="MapReduce"><a href="#MapReduce" class="headerlink" title="MapReduce"></a>MapReduce</h4><p>在用 MongoDB 查询时，若返回的数据量很大，或者做一些比较复杂的统计和聚合操作做花费的时间很长时，可以使用 MongoDB 中的  mapReduce 进行实现。mapReduce  是个灵活且强大的数据聚合工具，它的好处是可以把一个聚合任务分解为多个小的任务，分配到多个服务器上并行处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.collection_name.mapReduce(</span><br><span class="line">    function() &#123;emit(key, value);&#125;,                  // map 函数</span><br><span class="line">    function(key, values) &#123;return reduceFunction&#125;,   // reduce 函数</span><br><span class="line">    &#123;</span><br><span class="line">        out: collection,</span><br><span class="line">        query: document,</span><br><span class="line">        sort: document,</span><br><span class="line">        limit: number</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>map 函数：一个 javascript 函数，它用一个键映射一个值并发出一个键值对</li>
<li>reduce 函数：一个 javascript 函数，用于减少或分组具有相同键的所有文档</li>
<li>out：指定 map-reduce 查询结果的位置</li>
<li>query：指定用于选择文档的可选选择条件</li>
<li>sort：指定可选的排序条件</li>
<li>limit：指定要返回的最大文档数（可选）</li>
</ul>
<hr>
<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><h4 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h4><p>MongoDB 视图是一个可查询的对象，它的内容由其它集合或视图上的聚合管道定义。MongoDB 不会将视图内容持久化到磁盘，当客户查询视图时，视图的内容按需计算。MongoDB 可以要求客户端具有查询视图的权限，MongoDB 不会对视图进行写操作</p>
<p>作用：</p>
<ul>
<li>数据抽象</li>
<li>保护敏感数据的一种方法</li>
<li>只读</li>
<li>结合基于角色的授权，可按角色访问信息</li>
</ul>
<hr>
<h4 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h4><p>单个集合创建视图，比如查看当天价格最高的 10 笔订单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.createView(</span><br><span class="line">	&quot;orderInfo&quot;,  // 视图名称</span><br><span class="line">	&quot;order&quot;,  // 数据源</span><br><span class="line">	[</span><br><span class="line">		// 筛选符合条件的订单，大于当天，这里要注意时区</span><br><span class="line">		&#123;$match: &#123;&quot;orderTime&quot;: &#123;$gte: ISODate(&quot;2022-01-26T00:00:000Z&quot;)&#125;&#125;&#125;,</span><br><span class="line">		// 金额倒序</span><br><span class="line">		&#123;$sort: &#123;&quot;price&quot;: -1&#125;&#125;,</span><br><span class="line">		// 限制 10 个文档</span><br><span class="line">		&#123;$limit: 10&#125;,</span><br><span class="line">		// 选择需要输出的字段内容</span><br><span class="line">		&#123;$project: &#123;_id: 0, orderNo: 1, price: 1, orderTime: 1&#125;&#125;</span><br><span class="line">	]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<p>多个集合创建视图，多个集合创建视图与单个基本相同，致使多了 $lookup 关联文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.createView(</span><br><span class="line">	&quot;orderDetail&quot;,  // 视图名称</span><br><span class="line">	&quot;order&quot;,  // 数据源</span><br><span class="line">	[</span><br><span class="line">		&#123;$lookup : &#123;&quot;from&quot;: &quot;shipping&quot;, &quot;localField&quot;: &quot;orderNo&quot;, &quot;foreignField&quot;: &quot;orderNo&quot;, &quot;as&quot;: &quot;shipping&quot;&#125;&#125;,</span><br><span class="line">		// 选择需要输出的字段内容</span><br><span class="line">		&#123;$project: &#123;orderNo: 1, price: 1, shipping.address: 1&#125;&#125;</span><br><span class="line">	]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="SpringBoot-整合-MongoDB-聚合操作"><a href="#SpringBoot-整合-MongoDB-聚合操作" class="headerlink" title="SpringBoot 整合 MongoDB 聚合操作"></a>SpringBoot 整合 MongoDB 聚合操作</h3><h4 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Zips &#123;</span><br><span class="line"></span><br><span class="line">    private Double[] loc;</span><br><span class="line"></span><br><span class="line">    private Integer pop;</span><br><span class="line"></span><br><span class="line">    private String state;</span><br><span class="line">    </span><br><span class="line">    private String city;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="返回人口超过-100-万的州"><a href="#返回人口超过-100-万的州" class="headerlink" title="返回人口超过 100 万的州"></a>返回人口超过 100 万的州</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.zips.aggregate([</span><br><span class="line">	&#123;$group: &#123;_id: &quot;$state&quot;, totalPop: &#123;$sum: $pop&#125;&#125;&#125;,</span><br><span class="line">	&#123;$match: &#123;totalPop: &#123;$gt: 10 * 1000 * 1000&#125;&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        </span><br><span class="line">	<span class="comment">// $group</span></span><br><span class="line">	<span class="type">GroupOperation</span> <span class="variable">groupOperation</span> <span class="operator">=</span> Aggregation.group(<span class="string">&quot;state&quot;</span>).sum(<span class="string">&quot;pop&quot;</span>).as(<span class="string">&quot;totalPop&quot;</span>);</span><br><span class="line">	<span class="comment">// $match</span></span><br><span class="line">	<span class="type">MatchOperation</span> <span class="variable">matchOperation</span> <span class="operator">=</span> Aggregation.match(Criteria.where(<span class="string">&quot;totalPop&quot;</span>).gte(<span class="number">10</span> * <span class="number">1000</span> * <span class="number">1000</span>));</span><br><span class="line">	<span class="comment">// 按顺序组合每一个步骤</span></span><br><span class="line">	TypedAggregation&lt;Zips&gt; typedAggregation = Aggregation.newAggregation(Zips.class, groupOperation, matchOperation);</span><br><span class="line">	<span class="comment">// 执行聚合操作，如果不使用 Map，也可以使用实体类来接收数据</span></span><br><span class="line">	AggregationResults&lt;Map&gt; aggregationResults = mongoTemplate.aggregate(typedAggregation, Map.class);</span><br><span class="line">	<span class="comment">// 取出最终结果</span></span><br><span class="line">	List&lt;Map&gt; maps = aggregationResults.getMappedResults();</span><br><span class="line">	maps.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="返回各州的平均城市人口"><a href="#返回各州的平均城市人口" class="headerlink" title="返回各州的平均城市人口"></a>返回各州的平均城市人口</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.zips.aggregate([</span><br><span class="line">	&#123;$group: &#123;_id: &#123;state: &quot;$state&quot;, city: $city&#125;, cityPop: &#123;$sum: $pop&#125;&#125;&#125;,</span><br><span class="line">	&#123;$group: &#123;_id: &quot;$_id.state&quot;, avgCityPop: &#123;$avg: $cityPop&#125;&#125;,</span><br><span class="line">	&#123;$sort: &#123;avgCityPop: -1&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// $group</span></span><br><span class="line">    <span class="type">GroupOperation</span> <span class="variable">groupOperation1</span> <span class="operator">=</span> Aggregation.group(<span class="string">&quot;state&quot;</span>, <span class="string">&quot;city&quot;</span>).sum(<span class="string">&quot;pop&quot;</span>).as(<span class="string">&quot;cityPop&quot;</span>);</span><br><span class="line">    <span class="comment">// $group</span></span><br><span class="line">    <span class="type">GroupOperation</span> <span class="variable">groupOperation2</span> <span class="operator">=</span> Aggregation.group(<span class="string">&quot;_id.state&quot;</span>).avg(<span class="string">&quot;cityPop&quot;</span>).as(<span class="string">&quot;avgCityPop&quot;</span>);</span><br><span class="line">    <span class="comment">// $sort</span></span><br><span class="line">    <span class="type">SortOperation</span> <span class="variable">sortOperation</span> <span class="operator">=</span> Aggregation.sort(Sort.Direction.DESC, <span class="string">&quot;avgCityPop&quot;</span>);</span><br><span class="line">    <span class="comment">// 按顺序组合每一个步骤</span></span><br><span class="line">    TypedAggregation&lt;Zips&gt; typedAggregation = Aggregation.newAggregation(Zips.class, groupOperation1, groupOperation2, sortOperation);</span><br><span class="line">    <span class="comment">// 执行聚合操作，如果不使用 Map，也可以使用实体类来接收数据</span></span><br><span class="line">    AggregationResults&lt;Map&gt; aggregationResults = mongoTemplate.aggregate(typedAggregation, Map.class);</span><br><span class="line">    <span class="comment">// 取出最终结果</span></span><br><span class="line">    List&lt;Map&gt; maps = aggregationResults.getMappedResults();</span><br><span class="line">    maps.forEach(System.out::println);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="按州返回最大的和最小的城市"><a href="#按州返回最大的和最小的城市" class="headerlink" title="按州返回最大的和最小的城市"></a>按州返回最大的和最小的城市</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">db.zips.aggregate([</span><br><span class="line">	&#123;$group: </span><br><span class="line">		&#123;</span><br><span class="line">			_id: &#123;state: &quot;$state&quot;, city: &quot;$city&quot;&#125;,</span><br><span class="line">			pop: &#123;$sum: &quot;$pop&quot;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;$sort: &#123;pop: 1&#125;&#125;,</span><br><span class="line">	&#123;$group:</span><br><span class="line">		&#123;</span><br><span class="line">			_id: &quot;$_id.state&quot;,</span><br><span class="line">			biggestCity: &#123;$last: &quot;$_id.city&quot;&#125;,</span><br><span class="line">			biggestPop: &#123;$last: &quot;$pop&quot;&#125;,</span><br><span class="line">			smallestCity: &#123;$first: &quot;$_id.city&quot;&#125;,</span><br><span class="line">			smallestPop: &#123;$first: &quot;$pop&quot;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;$project:</span><br><span class="line">		&#123;</span><br><span class="line">			_id: 0,</span><br><span class="line">			state: &quot;$_id&quot;,</span><br><span class="line">			biggestCity: &#123;name: &quot;$biggestCity&quot;, pop: &quot;$biggestPop&quot;&#125;,</span><br><span class="line">			smallestCity: &#123;name: &quot;$smallestCity&quot;, pop: &quot;$smallestPop&quot;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;$sort: &#123;state: 1&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $group</span></span><br><span class="line">    <span class="type">GroupOperation</span> <span class="variable">groupOperation1</span> <span class="operator">=</span> Aggregation.group(<span class="string">&quot;state&quot;</span>, <span class="string">&quot;city&quot;</span>).sum(<span class="string">&quot;pop&quot;</span>).as(<span class="string">&quot;pop&quot;</span>);</span><br><span class="line">    <span class="comment">// $sort</span></span><br><span class="line">    <span class="type">SortOperation</span> <span class="variable">sortOperation1</span> <span class="operator">=</span> Aggregation.sort(Sort.Direction.DESC, <span class="string">&quot;pop&quot;</span>);</span><br><span class="line">    <span class="comment">// $group</span></span><br><span class="line">    <span class="type">GroupOperation</span> <span class="variable">groupOperation2</span> <span class="operator">=</span> Aggregation.group(<span class="string">&quot;_id.state&quot;</span>)</span><br><span class="line">            .last(<span class="string">&quot;_id.city&quot;</span>).as(<span class="string">&quot;biggestCity&quot;</span>)</span><br><span class="line">            .last(<span class="string">&quot;pop&quot;</span>).as(<span class="string">&quot;biggestPop&quot;</span>)</span><br><span class="line">            .first(<span class="string">&quot;_id.city&quot;</span>).as(<span class="string">&quot;smallestCity&quot;</span>)</span><br><span class="line">            .first(<span class="string">&quot;pop&quot;</span>).as(<span class="string">&quot;smallestPop&quot;</span>);</span><br><span class="line">    <span class="comment">// $project</span></span><br><span class="line">    <span class="type">ProjectionOperation</span> <span class="variable">projectionOperation</span> <span class="operator">=</span> Aggregation.project(<span class="string">&quot;biggestCIty&quot;</span>, <span class="string">&quot;smallCity&quot;</span>, <span class="string">&quot;state&quot;</span>)</span><br><span class="line">            .andExclude(<span class="string">&quot;_id&quot;</span>)</span><br><span class="line">            .andExpression(<span class="string">&quot;&#123;name: \&quot;$biggestCity\&quot;, pop: \&quot;$biggestPop\&quot;&#125;&quot;</span>)</span><br><span class="line">            .as(<span class="string">&quot;biggestCity&quot;</span>)</span><br><span class="line">            .andExpression(<span class="string">&quot;&#123;name: \&quot;$smallestCity\&quot;, pop: \&quot;$smallestPop\&quot;&#125;&quot;</span>)</span><br><span class="line">            .as(<span class="string">&quot;smallestCity&quot;</span>);</span><br><span class="line">    <span class="comment">// $sort</span></span><br><span class="line">    <span class="type">SortOperation</span> <span class="variable">sortOperation2</span> <span class="operator">=</span> Aggregation.sort(Sort.Direction.DESC, <span class="string">&quot;state&quot;</span>);</span><br><span class="line">    <span class="comment">// 按顺序组合每一个步骤</span></span><br><span class="line">    TypedAggregation&lt;Zips&gt; typedAggregation = Aggregation.newAggregation(Zips.class, groupOperation1, sortOperation1, groupOperation2, projectionOperation, sortOperation2);</span><br><span class="line">    <span class="comment">// 执行聚合操作，如果不使用 Map，也可以使用实体类来接收数据</span></span><br><span class="line">    AggregationResults&lt;Map&gt; aggregationResults = mongoTemplate.aggregate(typedAggregation, Map.class);</span><br><span class="line">    <span class="comment">// 取出最终结果</span></span><br><span class="line">    List&lt;Map&gt; maps = aggregationResults.getMappedResults();</span><br><span class="line">    maps.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><h4 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h4><p>与 MySQL 类似，MongoDB 也可以设置索引，并且 MongoDB 索引的数据结构也是 B+ 树</p>
<hr>
<h4 id="索引的分类"><a href="#索引的分类" class="headerlink" title="索引的分类"></a>索引的分类</h4><ul>
<li>按照索引包含的字段的数量，可分为单键索引和组合索引（也称为复合索引）</li>
<li>按照字段的类型，可分住主键索引和非主键索引</li>
<li>按照索引节点与物理数据的对应方式，可分为聚簇索引和非聚簇索引</li>
<li>按照索引特性的不同，又可以分为唯一索引、稀疏索引、文本索引、地理空间索引等</li>
</ul>
<p>与大多数数据库一样，MongoDB 支持各种丰富的索引类型，包括单键索引、复合索引、唯一索引等一些常用结构。由于采用了灵活可变的文档类型，因此同样支持嵌套字段、数组的索引。通过建立合适的索引，可以极大提升数据的检索速度，在一些特殊的应用场景，MongoDB 还支持地理空间索引、文本检索索引、TTL 索引等</p>
<hr>
<h4 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h4><p>创建索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.createIndex(keys, options)</span><br></pre></td></tr></table></figure>

<p>语法中 Key 值为你要创建的索引字段，1 为指定按升序创建索引，如果你想按降序来创建索引指定为 -1 即可</p>
<p>options 为可选参数，可选参数列表如下</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>background</td>
<td>Boolean</td>
<td>建索引过程会阻塞其它数据库操作，background 可指定以后台方式创建索引，即增加 “background” 可选参数。  “background” 默认值为 false</td>
</tr>
<tr>
<td>unique</td>
<td>Boolean</td>
<td>建立的索引是否唯一。指定为 true 创建唯一索引。默认值为 false</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
<td>索引的名称。如果未指定，MongoDB的通过连接索引的字段名和排序顺序生成一个索引名称</td>
</tr>
<tr>
<td>dropDups</td>
<td>Boolean</td>
<td>3.0+ 版本已废弃。在建立唯一索引时是否删除重复记录,指定 true 创建唯一索引。默认值为 false</td>
</tr>
<tr>
<td>sparse</td>
<td>Boolean</td>
<td>对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为 true 的话，在索引字段中不会查询出不包含对应字段的文档.。默认值为 false</td>
</tr>
<tr>
<td>expireAfterSeconds</td>
<td>integer</td>
<td>指定一个以秒为单位的数值，完成 TTL 设定，设定集合的生存时间</td>
</tr>
<tr>
<td>v</td>
<td>index version</td>
<td>索引的版本号。默认的索引版本取决于 mongod 创建索引时运行的版本</td>
</tr>
<tr>
<td>weights</td>
<td>document</td>
<td>索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重</td>
</tr>
<tr>
<td>default_language</td>
<td>string</td>
<td>对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语</td>
</tr>
<tr>
<td>language_override</td>
<td>string</td>
<td>对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的language，默认值为 language</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 创建索引后台执行</span><br><span class="line">db.values.createIndex(&#123;open: 1, close: 1&#125;, &#123;backgroud: true&#125;)</span><br><span class="line">// 创建唯一索引</span><br><span class="line">db.values.createIndex(&#123;title: 1&#125;, &#123;unique: true&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 查看索引信息</span><br><span class="line">db.books.getIndexes()</span><br><span class="line">// 查看索引键</span><br><span class="line">db.books.getIndexKeys()</span><br><span class="line">// 查看索引大小</span><br><span class="line">// 可传入值，传入 0 或 false 以外的任何数据，都会显示每个索引大小以及总大小，传入 0 或 false 时则只会显示总大小，默认为 false</span><br><span class="line">db.books.totalIndexSize(value)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 删除指定索引</span><br><span class="line">db.books.dropIndex(&quot;索引名称&quot;)</span><br><span class="line">// 删除集合中的所有索引</span><br><span class="line">db.books.dropIndexes()</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="单键索引"><a href="#单键索引" class="headerlink" title="单键索引"></a>单键索引</h4><p>在某一个特定的字段上建立索引，MongoDB 在 id 字段上建立了唯一单键索引，所以经常会使用 id 来进行查询；在索引字段上进行精确匹配、排序和范围查找时都会使用此索引</p>
<hr>
<h4 id="地理空间索引"><a href="#地理空间索引" class="headerlink" title="地理空间索引"></a>地理空间索引</h4><p>在移动互联网时代，基于地理位置的检索（LBS）功能几乎是所有应用系统的标配。MongoDB 为地理空间检索提供了非常方便的功能。地理空间索引就是专门用于实现位置检索的一种特殊索引</p>
<p>假设商家的数据模型如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.restaurant.insert(&#123;</span><br><span class="line">	restaurantId: 0,</span><br><span class="line">	restaurantName: &quot;兰州拉面&quot;,</span><br><span class="line">	localtion: &#123;</span><br><span class="line">		type: &quot;Point&quot;,</span><br><span class="line">		coordinates: [-73.97, 40.77]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>创建一个 2dsphere 索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.restaurant.createIndex(&#123;localtion: &quot;2dsphere&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>查询附近 10000 米内商家信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.restaurant.find(&#123;</span><br><span class="line">	localtion: &#123;</span><br><span class="line">		$near: &#123;</span><br><span class="line">			$geometry: &#123;</span><br><span class="line">				type: &quot;Point&quot;,</span><br><span class="line">				coordinates: [-73.97, 40.77]</span><br><span class="line">			&#125;,</span><br><span class="line">			$maxDistance: 10000</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>$near 查询操作符，用于实现附近商家的检索，返回的结果会按照距离排序</li>
<li>$geometry 操作符用于指定一个 GeoJSON 格式的地理空间对象，type &#x3D; Point 表示地理坐标点，coordinates 则是当前经纬度，$maxdistance 限定了范围，单位是米</li>
</ul>
<hr>
<h4 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h4><p>MongoDB 支持全文检索功能，可通过建立文本索引来实现简易的分词检索</p>
<p>$text 操作符可以在有 text index 的集合上执行文本检索。$text 将会使用空格和标点符号作为分隔符对检索字符串进行分词，并且对检索字符串中所有的分词结果进行一个逻辑上的 OR 操作</p>
<p>数据内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.stores.insert([</span><br><span class="line">	&#123;_id: 1, name: &quot;Java&quot;, description: &quot;Java Code&quot;&#125;,</span><br><span class="line">	&#123;_id: 2, name: &quot;MongoDB&quot;, description: &quot;database MongoDB&quot;&#125;</span><br><span class="line">	&#123;_id: 3, name: &quot;MySQL&quot;, description: &quot;database MySQL&quot;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>创建 name 和 description 的全文索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.stores.createIndex(&#123;name: &quot;text&quot;, description: &quot;text&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>查询包含有 database 的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.stores.find(&#123;$text: &#123;$search: &quot;database&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p>MongoDB 暂未提供中文分词功能，这使得该功能的使用场景十分受限</p>
<hr>
<h4 id="Hash-索引"><a href="#Hash-索引" class="headerlink" title="Hash 索引"></a>Hash 索引</h4><p>不同于传统的 B-Tree 索引，哈希索引使用 hash 函数来创建索引。在索引字段上进行精确匹配，但不支持范围查询，不支持多键 hash。Hash 索引上的入口时均匀分布的，这在分片集合中非常有用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.createIndex(&#123;username: &quot;hashed&quot;&#125;)</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="通配符索引"><a href="#通配符索引" class="headerlink" title="通配符索引"></a>通配符索引</h4><p>MongoDB 的文档模式是动态变化的，而通配符索引可以建立在一些不可预知的字段上，以实现查询的加速。MongoDB 4.2 引入了通配符索引来支持对未知或任意字段的查询</p>
<p>数据准备，不同的商品属性不同</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">db.products.insert([</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;product_name&quot;: &quot;Spy Coat&quot;,</span><br><span class="line">		&quot;product_attributes&quot;: &#123;</span><br><span class="line">			&quot;material&quot;: [&quot;Tweed&quot;, &quot;Wool&quot;, &quot;leather&quot;],</span><br><span class="line">			&quot;size&quot;: &#123;</span><br><span class="line">				&quot;length&quot;: 72,</span><br><span class="line">				&quot;units&quot;: &quot;inches&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;product_name&quot;: &quot;Spy Pen&quot;,</span><br><span class="line">		&quot;product_attributes&quot;: &#123;</span><br><span class="line">			&quot;colors&quot;: [&quot;blue&quot;, &quot;black&quot;],</span><br><span class="line">			&quot;secrect_feather&quot;: &#123;</span><br><span class="line">				&quot;name&quot;: &quot;laser&quot;,</span><br><span class="line">				&quot;power&quot;: &quot;1000&quot;,</span><br><span class="line">				&quot;units&quot;: &quot;watts&quot;</span><br><span class="line">			&#125; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;product_name&quot;: &quot;Spy Book&quot;</span><br><span class="line">	&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>创建通配符索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.products.createIndex(&#123;&quot;product_attributes.$**&quot;: 1&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>注意，通配符索引不兼容索引类型或属性</li>
<li>通配符索引是稀疏的，不索引空字段。因此，通配符索引不能支持查询字段不存在的文档</li>
<li>通配符索引为文档或数组的内容生成条目，而不失文档&#x2F;数组本身。因此通配符索引不能支持精确的文档&#x2F;数组匹配。通配符索引可以支持查询字段等于空文档 {} 的情况</li>
</ul>
<hr>
<h4 id="唯一索引"><a href="#唯一索引" class="headerlink" title="唯一索引"></a>唯一索引</h4><p>在现实场景中，唯一性是很常见的一种索引约束需求，重复的数据记录会带来许多处理上的麻烦，比如订单的编号、用户名等等。通过建立唯一性索引，可以保证集合中文档的指定字段拥有唯一值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 创建唯一索引</span><br><span class="line">db.values.createIndex(&#123;title: 1&#125;, &#123;unique: true&#125;)</span><br><span class="line">// 复合索引支持唯一性约束</span><br><span class="line">db.values.createIndex(&#123;title: 1, type: 1&#125;, &#123;unique: true&#125;)</span><br><span class="line">// 多键索引支持唯一性约束</span><br><span class="line">db.values.createIndex(&#123;ratings: 1&#125;, &#123;unique: true&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>唯一索引对于文档中缺失的字段，会用 null 代替，因此不存在允许多个文档缺失索引字段的情况</li>
<li>对于分片的集合，唯一性约束必须匹配分片规则。换句话说，为了保证全局的唯一性，分片键必须作为唯一性索引的前缀字段</li>
</ul>
<hr>
<h4 id="部分索引"><a href="#部分索引" class="headerlink" title="部分索引"></a>部分索引</h4><p>部分索引仅对满足指定过滤器表达式的文档进行索引。通过在一个集合中为文档的一个子集建立索引，部分索引具有更低的存储需求和更低的创建及维护成本，3.2 版本新增功能</p>
<p>部分索引提供了稀疏索引功能的超集，优先级应高于稀疏索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.restaurants.createIndex(</span><br><span class="line">	&#123;cuisine: 1, name: 1&#125;,</span><br><span class="line">	&#123;partialFilterExpression: &#123;rating: &#123;$gt: 5&#125;&#125;&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 符合条件，可以触发索引</span><br><span class="line">db.restaurants.find(&#123;cuisine: &quot;Italian&quot;, rating: &#123;$gt: 8&#125;&#125;)</span><br><span class="line">// 不符合条件，不触发索引</span><br><span class="line">db.restaurants.find(&#123;cuisine: &quot;Italian&quot;&#125;)</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="稀疏索引"><a href="#稀疏索引" class="headerlink" title="稀疏索引"></a>稀疏索引</h4><p>索引的稀疏属性确保索引只包含具有索引字段的文档的条目，索引将跳过没有索引字段的文档</p>
<p>特性：只对存在字段的文档进行（包含字段值为 null 的文档）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.addresses.createIndex(&#123;&quot;xmpp_id: 1&quot;&#125;, &#123;sparse: true&#125;)</span><br></pre></td></tr></table></figure>

<p>如果稀疏索引会导致查询和排序操作的结果集不完成，MongoDB 将不会使用索引，除非 hint() 明确指定索引</p>
<hr>
<h4 id="TTL-索引"><a href="#TTL-索引" class="headerlink" title="TTL 索引"></a>TTL 索引</h4><p>在一般的应用系统中，并非所有数据都需要永久存储。例如一些系统事件、用户消息等，这些数据随着时间的推移，其重要程度逐渐降低。更重要的是，存储这些大量的历史数据需要花费较高的成本，因此项目中通常会对过期且不再使用的数据进行老化处理</p>
<p>通常的做法如下：</p>
<p>方案一：为每个数据记录一个时间戳，应用侧开启一个定时器，按时间戳定期删除过期的数据</p>
<p>方案二：数据按日期进行分表，同一天的数据归档到同一张表，同样使用定时器删除过期的表</p>
<p>对于数据老化，MongoDB 提供了一种更便捷的做法：TTL 索引。TTL 索引需要声明一个日期类型的字段，TTL 索引是特殊的单字段索引，MongoDB 可以使用它在一定时间或特定时间时钟后自动从集合中删除文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 创建 TTL 索引，TTL 值为 3600 秒</span><br><span class="line">db.eventLog.createIndex(&#123;&quot;lastMofiedTime&quot;: 1&#125;, &#123;expireAfterSeconds: 3600&#125;)</span><br></pre></td></tr></table></figure>

<p>对集合创建 TTL 索引之后，MongoDB 会周期性的运行后台线程对该集合进行检查以及数据清理工作。除了数据老化功能，TTL 索引具有普通索引的功能，同样用于加速数据的查询</p>
<p>TTL 索引不保证过期数据在过期后会立即被删除，文档过期和 MongoDB 从集合中删除文档的时间可能存在延迟，删除过期文档的后台程序每 60 秒运行一次。因此，文档到期和后台任务运行的时间段内，文档仍会存在</p>
<p>TTL 索引的确可以减少开发的工作量，而且通过数据库自动清理的方式更加高效可靠，但是使用 TTL 索引需要注意以下事项：</p>
<ul>
<li>TTL 索引只支持单个字段，并且必须是非 _id 字段</li>
<li>TTL 索引不能用于固定集合</li>
<li>TTL 索引不能保证及时的数据老化，MongoDB 会通过后台的 TTL Monitor 定时器来清理老化数据，默认的间隔时间是 1 分钟。当然在数据库负载过高的情况下，TTL 的行为则会收到进一步的影响</li>
<li>TTL 索引对数据库的清理仅使用了remove 命令，这种方式并不是很高效。因此 TTL Monitor 在运行期间对系统 CPU、磁盘都会造成一定的压力。相比之下，按日期分表的方式更加高效</li>
</ul>
<hr>
<h4 id="隐藏索引"><a href="#隐藏索引" class="headerlink" title="隐藏索引"></a>隐藏索引</h4><p>隐藏索引对查询规划器不可见，不能用于支持查询。通过对规划器隐藏索引，用户可以在不实际删除索引的情况下评估删除索引的潜在影响。如果影响是负面的，用户可以取消隐藏索引，而不必重新创建索引，4.4 版本新功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 创建隐藏索引</span><br><span class="line">db.restaurant.createIndex(&#123;borough: 1&#125;, &#123;hidden: true&#125;)</span><br><span class="line">// 隐藏现有索引</span><br><span class="line">db.restaurant.hiddenIndex(&#123;borough: 1&#125;)</span><br><span class="line">db.restaurant.hiddenIndex(&quot;索引名称&quot;)</span><br><span class="line">// 取消隐藏索引</span><br><span class="line">db.restaurant.unhiddenIndex(&#123;borough: 1&#125;)</span><br><span class="line">db.restaurant.unhiddenIndex(&quot;索引名称&quot;)</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="执行计划"><a href="#执行计划" class="headerlink" title="执行计划"></a>执行计划</h4><p>MongoDB 提供了 explain 命令，帮助我们评估指定查询模型的执行计划，然后根据实际情况进行调整，提高查询效率</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find().explain(&lt;verbose&gt;)</span><br></pre></td></tr></table></figure>

<p>verbose 为可选参数，表示执行计划的输出模式，共有 3 个值，默认为 queryPlanner</p>
<ul>
<li><p>queryPlanner</p>
<p>执行计划的详细信息，包括查询计划、集合信息、查询条件、最佳执行计划、查询方式和 MongoDB 服务信息等</p>
</li>
<li><p>executionStats</p>
<p>最佳执行计划的执行情况和被拒绝的计划等信息</p>
</li>
<li><p>allPlansExecution</p>
<p>选择并执行最佳执行计划，并返回最佳执行计划和其它执行计划的执行情况</p>
</li>
</ul>
<p>queryPlanner 响应参数</p>
<p><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%20%E5%AE%9E%E6%88%98/image-20230101223029240.png" alt="image-20230101223029240"></p>
<p>executionStats 响应参数</p>
<p><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%20%E5%AE%9E%E6%88%98/image-20230101223052859.png" alt="image-20230101223052859"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://yoursite.com">Simon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2023/01/01/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%E5%AE%9E%E6%88%98/">http://yoursite.com/2023/01/01/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%E5%AE%9E%E6%88%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">Simon 的书柜</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a class="post-meta__tags" href="/tags/MongoDB/">MongoDB</a></div><div class="post_share"><div class="social-share" data-image="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB%20%E5%AE%9E%E6%88%98/preview.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/19/Java/Nacos%20%E5%92%8C%20Eureka%20%E7%9A%84%E5%AF%B9%E6%AF%94/" title="Nacos 和 Eureka 的对比"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Nacos%20%E5%92%8C%20Eureka%20%E5%AF%B9%E6%AF%94/preview.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Nacos 和 Eureka 的对比</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/03/Java/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%BB%84%E4%BB%B6%E4%B9%8B%20Sentinel/" title="流量控制组件之 Sentinel"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%BB%84%E4%BB%B6%E4%B9%8BSentinel/pexels-ciboulette-574024.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">流量控制组件之 Sentinel</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/10/28/%E6%95%B0%E6%8D%AE%E5%BA%93/ElasticSearch%20%E5%AE%9E%E6%88%98/" title="ElasticSearch 实战"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/ElasticSearch%20%E5%AE%9E%E6%88%98/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-28</div><div class="title">ElasticSearch 实战</div></div></a></div><div><a href="/2023/03/27/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%20%E4%BB%8E%E8%8F%9C%E9%B8%9F%E5%88%B0%E5%A4%A7%E7%89%9B%E4%B9%8B%E5%88%9D%E7%BA%A7%E7%AF%87/" title="MySQL 从菜鸟到大牛之初级篇"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E4%BB%8E%E8%8F%9C%E9%B8%9F%E5%88%B0%E5%A4%A7%E7%A5%9E%E4%B9%8B%E5%88%9D%E7%BA%A7%E7%AF%87/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-27</div><div class="title">MySQL 从菜鸟到大牛之初级篇</div></div></a></div><div><a href="/2023/03/12/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis%20%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98/" title="Redis 核心技术与实战"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis%20%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-12</div><div class="title">Redis 核心技术与实战</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E8%83%8C%E6%99%AF%E5%9B%BE/v2-bd12bc8dfb61abe313ad48b907c5da94_720w.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Simon</div><div class="author-info__description">攀登亦是风景</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/CK-shadow" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ck1996shadow@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB-%E5%AE%9E%E6%88%98"><span class="toc-number">1.</span> <span class="toc-text">MongoDB 实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-MongoDB"><span class="toc-number">1.1.1.</span> <span class="toc-text">什么是 MongoDB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8A%BF"><span class="toc-number">1.1.2.</span> <span class="toc-text">技术优势</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.3.</span> <span class="toc-text">应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mongo-Shell"><span class="toc-number">1.2.</span> <span class="toc-text">Mongo Shell</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.2.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E5%8F%B7"><span class="toc-number">1.2.3.</span> <span class="toc-text">创建管理员账号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7"><span class="toc-number">1.2.4.</span> <span class="toc-text">创建应用数据库用户</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.</span> <span class="toc-text">集合操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%9B%86%E5%90%88"><span class="toc-number">1.3.1.</span> <span class="toc-text">创建集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E9%9B%86%E5%90%88"><span class="toc-number">1.3.2.</span> <span class="toc-text">删除集合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.</span> <span class="toc-text">文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3"><span class="toc-number">1.4.1.</span> <span class="toc-text">新增文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="toc-number">1.4.2.</span> <span class="toc-text">更新文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">1.4.3.</span> <span class="toc-text">查询文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-number">1.4.4.</span> <span class="toc-text">删除文档</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringBoot-%E6%95%B4%E5%90%88"><span class="toc-number">1.5.</span> <span class="toc-text">SpringBoot 整合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.5.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3"><span class="toc-number">1.5.2.</span> <span class="toc-text">添加文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3-1"><span class="toc-number">1.5.3.</span> <span class="toc-text">查询文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3-1"><span class="toc-number">1.5.4.</span> <span class="toc-text">更新文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3-1"><span class="toc-number">1.5.5.</span> <span class="toc-text">删除文档</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">1.6.</span> <span class="toc-text">聚合操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-number">1.6.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%B8%80%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">1.6.2.</span> <span class="toc-text">单一聚合操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E7%AE%A1%E9%81%93"><span class="toc-number">1.6.3.</span> <span class="toc-text">聚合管道</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MapReduce"><span class="toc-number">1.6.4.</span> <span class="toc-text">MapReduce</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE"><span class="toc-number">1.7.</span> <span class="toc-text">视图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="toc-number">1.7.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE"><span class="toc-number">1.7.2.</span> <span class="toc-text">创建视图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringBoot-%E6%95%B4%E5%90%88-MongoDB-%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">1.8.</span> <span class="toc-text">SpringBoot 整合 MongoDB 聚合操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">1.8.1.</span> <span class="toc-text">实体类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E4%BA%BA%E5%8F%A3%E8%B6%85%E8%BF%87-100-%E4%B8%87%E7%9A%84%E5%B7%9E"><span class="toc-number">1.8.2.</span> <span class="toc-text">返回人口超过 100 万的州</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%90%84%E5%B7%9E%E7%9A%84%E5%B9%B3%E5%9D%87%E5%9F%8E%E5%B8%82%E4%BA%BA%E5%8F%A3"><span class="toc-number">1.8.3.</span> <span class="toc-text">返回各州的平均城市人口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%89%E5%B7%9E%E8%BF%94%E5%9B%9E%E6%9C%80%E5%A4%A7%E7%9A%84%E5%92%8C%E6%9C%80%E5%B0%8F%E7%9A%84%E5%9F%8E%E5%B8%82"><span class="toc-number">1.8.4.</span> <span class="toc-text">按州返回最大的和最小的城市</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.</span> <span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-4"><span class="toc-number">1.9.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.9.2.</span> <span class="toc-text">索引的分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C"><span class="toc-number">1.9.3.</span> <span class="toc-text">索引操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E9%94%AE%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.4.</span> <span class="toc-text">单键索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E7%A9%BA%E9%97%B4%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.5.</span> <span class="toc-text">地理空间索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.6.</span> <span class="toc-text">全文索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hash-%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.7.</span> <span class="toc-text">Hash 索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.8.</span> <span class="toc-text">通配符索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.9.</span> <span class="toc-text">唯一索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.10.</span> <span class="toc-text">部分索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A8%80%E7%96%8F%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.11.</span> <span class="toc-text">稀疏索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TTL-%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.12.</span> <span class="toc-text">TTL 索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.13.</span> <span class="toc-text">隐藏索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-number">1.9.14.</span> <span class="toc-text">执行计划</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/09/16/Java/Spring%20Cloud%20Alibaba%20%E5%AE%9E%E6%88%98/" title="Spring Cloud Alibaba 实战"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Spring%20Cloud%20Alibaba%20%E5%AE%9E%E6%88%98/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring Cloud Alibaba 实战"/></a><div class="content"><a class="title" href="/2024/09/16/Java/Spring%20Cloud%20Alibaba%20%E5%AE%9E%E6%88%98/" title="Spring Cloud Alibaba 实战">Spring Cloud Alibaba 实战</a><time datetime="2024-09-16T10:10:01.000Z" title="发表于 2024-09-16 18:10:01">2024-09-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%BC%95%E6%93%8E%20Camunda%207/" title="工作流引擎 Camunda 7"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%BC%95%E6%93%8E%20Camunda%207/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="工作流引擎 Camunda 7"/></a><div class="content"><a class="title" href="/2024/08/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%BC%95%E6%93%8E%20Camunda%207/" title="工作流引擎 Camunda 7">工作流引擎 Camunda 7</a><time datetime="2024-08-10T04:59:43.000Z" title="发表于 2024-08-10 12:59:43">2024-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/01/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/RabbitMQ%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98/" title="RabbitMQ 从入门到实战"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RabbitMQ 从入门到实战"/></a><div class="content"><a class="title" href="/2024/07/01/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/RabbitMQ%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98/" title="RabbitMQ 从入门到实战">RabbitMQ 从入门到实战</a><time datetime="2024-06-30T19:23:13.000Z" title="发表于 2024-07-01 03:23:13">2024-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/15/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E4%B8%8E%E8%AE%BE%E8%AE%A1/" title="秒杀系统的架构与设计"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E4%B8%8E%E8%AE%BE%E8%AE%A1/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="秒杀系统的架构与设计"/></a><div class="content"><a class="title" href="/2024/06/15/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9E%B6%E6%9E%84%E4%B8%8E%E8%AE%BE%E8%AE%A1/" title="秒杀系统的架构与设计">秒杀系统的架构与设计</a><time datetime="2024-06-15T01:37:58.000Z" title="发表于 2024-06-15 09:37:58">2024-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/12/%E5%89%8D%E7%AB%AF/Anaular%20%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/" title="Anaular 中文文档"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E5%89%8D%E7%AB%AF/Angular%20%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Anaular 中文文档"/></a><div class="content"><a class="title" href="/2024/05/12/%E5%89%8D%E7%AB%AF/Anaular%20%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/" title="Anaular 中文文档">Anaular 中文文档</a><time datetime="2024-05-12T06:08:47.000Z" title="发表于 2024-05-12 14:08:47">2024-05-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Simon</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>