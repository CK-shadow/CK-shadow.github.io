<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Lua 脚本实战 | Simon 的书柜</title><meta name="author" content="Simon"><meta name="copyright" content="Simon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Lua 脚本实战简介Lua 是一个由 C 语言编写的小巧的脚本语言，其设计目的是为了通过灵活嵌入应用程序中从而为应用程序提供灵活的扩展和控制功能。在所有的脚本引擎中，Lua 的速度是最快的，Lua 是作为嵌入式脚本的最佳选择 应用场景有：  游戏开发 独立应用脚本 Web 应用脚本 扩展和数据库插件如 MySQL Proxy 和 MySQL WorkBench 安全系统，如入侵检测系统 Nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="Lua 脚本实战">
<meta property="og:url" content="http://yoursite.com/2024/10/31/Java/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="Simon 的书柜">
<meta property="og:description" content="Lua 脚本实战简介Lua 是一个由 C 语言编写的小巧的脚本语言，其设计目的是为了通过灵活嵌入应用程序中从而为应用程序提供灵活的扩展和控制功能。在所有的脚本引擎中，Lua 的速度是最快的，Lua 是作为嵌入式脚本的最佳选择 应用场景有：  游戏开发 独立应用脚本 Web 应用脚本 扩展和数据库插件如 MySQL Proxy 和 MySQL WorkBench 安全系统，如入侵检测系统 Nginx">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/preview.jpg">
<meta property="article:published_time" content="2024-10-31T00:41:19.000Z">
<meta property="article:modified_time" content="2025-08-14T14:44:32.168Z">
<meta property="article:author" content="Simon">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/preview.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2024/10/31/Java/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Lua 脚本实战',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-14 22:44:32'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E8%83%8C%E6%99%AF%E5%9B%BE/v2-bd12bc8dfb61abe313ad48b907c5da94_720w.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">40</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/preview.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Simon 的书柜"><span class="site-name">Simon 的书柜</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Lua 脚本实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-31T00:41:19.000Z" title="发表于 2024-10-31 08:41:19">2024-10-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-14T14:44:32.168Z" title="更新于 2025-08-14 22:44:32">2025-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Lua 脚本实战"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Lua-脚本实战"><a href="#Lua-脚本实战" class="headerlink" title="Lua 脚本实战"></a>Lua 脚本实战</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Lua 是一个由 C 语言编写的小巧的脚本语言，其设计目的是为了通过灵活嵌入应用程序中从而为应用程序提供灵活的扩展和控制功能。在所有的脚本引擎中，Lua 的速度是最快的，Lua 是作为嵌入式脚本的最佳选择</p>
<p>应用场景有：</p>
<ol>
<li>游戏开发</li>
<li>独立应用脚本</li>
<li>Web 应用脚本</li>
<li>扩展和数据库插件如 MySQL Proxy 和 MySQL WorkBench</li>
<li>安全系统，如入侵检测系统</li>
<li>Nginx + Lua 开发高性能 Web 应用，限流、防 SQL 注入、请求过滤、黑白名单限制等</li>
</ol>
<p>它的特性有：</p>
<ul>
<li>轻量级: 它用标准 C 语言编写并以源代码形式开放，编译后仅仅一百余 K，可以很方便的嵌入别的程序里</li>
<li>可扩展: Lua 提供了非常易于使用的扩展接口和机制：由宿主语言 (通常是 C 或 C++) 提供这些功能，Lua 可以使用它们，就像是本来就内置的功能一样</li>
<li>支持面向过程编程和函数式编程</li>
<li>自动内存管理；只提供了一种通用类型的表（table），用它可以实现数组，哈希表，集合，对象</li>
<li>语言内置模式匹配；闭包；函数也可以看做一个值；提供多线程（协同进程，并非操作系统所支持的线程）支持</li>
<li>通过闭包和 table 可以很方便地支持面向对象编程所需要的一些关键机制，比如数据抽象，虚函数，继承和重载等</li>
</ul>
<hr>
<h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2><p><strong>Linux 安装</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -L -R -O https://www.lua.org/ftp/lua-5.4.7.tar.gz</span><br><span class="line">tar zxf lua-5.4.7.tar.gz</span><br><span class="line"><span class="built_in">cd</span> lua-5.4.7</span><br><span class="line">make all <span class="built_in">test</span></span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">或者使用安装工具</span><br><span class="line"></span><br><span class="line">sudo yum install epel-release</span><br><span class="line">sudo yum install lua</span><br></pre></td></tr></table></figure>



<p><strong>Mac 安装</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -L -R -O https://www.lua.org/ftp/lua-5.4.7.tar.gz</span><br><span class="line">tar zxf lua-5.4.7.tar.gz</span><br><span class="line">cd lua-5.4.7</span><br><span class="line">make all test</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">或者使用安装工具</span><br><span class="line"></span><br><span class="line">brew install lua</span><br></pre></td></tr></table></figure>



<p><strong>Windows 安装</strong></p>
<p>window 下可以使用一个叫 “SciTE” 的 IDE 环 境来执行 lua 程序，下载地址为：</p>
<p>Github 下载地址：<a target="_blank" rel="noopener" href="https://github.com/rjpcomputing/luaforwindows/releases">https://github.com/rjpcomputing/luaforwindows/releases</a></p>
<p>Google Code下载地址 : <a target="_blank" rel="noopener" href="https://code.google.com/p/luaforwindows/downloads/list">https://code.google.com/p/luaforwindows/downloads/list</a></p>
<hr>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><p><strong>注释</strong></p>
<p>单行注释以两个连字符 <code>--</code> 开头，后面跟随的内容将被解释器忽略</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 单行注释</span></span><br></pre></td></tr></table></figure>

<p>多行注释以 <code>--[[</code> 开始，并以 <code>]]</code> 结束，适用于需要对大段代码进行说明的情况</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment"> 多行注释</span></span><br><span class="line"><span class="comment"> 多行注释</span></span><br><span class="line"><span class="comment"> --]]</span></span><br></pre></td></tr></table></figure>

<p>Lua 不支持嵌套注释，这意味着在一个多行注释内不能再嵌套另一个多行注释</p>
<p><strong>标识符</strong></p>
<p>Lua 标识符用于定义一个变量，函数获取其他用户定义的项。标识符以一个字母 A 到 Z 或 a 到 z 或下划线 <strong>_</strong> 开头后加上 0 个或多个字母，下划线，数字（0 到 9）</p>
<p>最好不要使用下划线加大写字母的标识符，因为 Lua 的保留字也是这样的</p>
<p>Lua 不允许使用特殊字符如 @, $, 和 % 来定义标识符。 Lua 是一个区分大小写的编程语言。因此在 Lua 中 Runoob 与 runoob 是两个不同的标识符</p>
<p>一般约定，以下划线开头连接一串大写字母的名字（比如 _VERSION）被保留用于 Lua 内部全局变量</p>
<p><strong>全局变量</strong></p>
<p>在默认情况下，变量总是认为是全局的</p>
<p>全局变量不需要声明，给一个变量赋值后即创建了这个全局变量，访问一个没有初始化的全局变量也不会出错，只不过得到的结果是：nil</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">print</span>(b)</span><br><span class="line">nil</span><br><span class="line">&gt; b=10</span><br><span class="line">&gt; <span class="built_in">print</span>(b)</span><br><span class="line">10</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>如果想删除一个全局变量，只需要将变量赋值为 nil</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">print</span>(b)      <span class="comment">--&gt; nil</span></span><br></pre></td></tr></table></figure>

<p>这样变量 b 就好像从没被使用过一样。换句话说, 当且仅当一个变量不等于 nil 时，这个变量才存在</p>
<hr>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>Lua 是动态类型语言，变量不要类型定义,只需要为变量赋值。 值可以存储在变量中，作为参数传递或结果返回</p>
<p>Lua 中有 8 个基本类型分别为：nil、boolean、number、string、userdata、function、thread 和 table</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>nil</td>
<td>这个最简单，只有值 nil 属于该类，表示一个无效值（在条件表达式中相当于 false）</td>
</tr>
<tr>
<td>boolean</td>
<td>包含两个值：false 和 true</td>
</tr>
<tr>
<td>number</td>
<td>表示双精度类型的实浮点数</td>
</tr>
<tr>
<td>string</td>
<td>字符串由一对双引号或单引号来表示</td>
</tr>
<tr>
<td>userdata</td>
<td>表示任意存储在变量中的 C 数据结构</td>
</tr>
<tr>
<td>function</td>
<td>由 C 或 Lua 编写的函数</td>
</tr>
<tr>
<td>thread</td>
<td>表示执行的独立线路，用于执行协同程序</td>
</tr>
<tr>
<td>table</td>
<td>Lua 中的表（table）其实是一个关联数组，数组的索引可以是数字、字符串或表类型。在 Lua 里，table 的创建是通过 “构造表达式” 来完成，最简单构造表达式是 {}，用来创建一个空表</td>
</tr>
</tbody></table>
<ul>
<li><p>nil</p>
<p>nil 类型表示一种没有任何有效值，它只有一个值 – nil</p>
<p>对于全局变量和 table，nil 还有一个删除作用，给全局变量或者 table 表里的变量赋一个 nil 值，等同于把它们删掉</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tab1 = &#123; key1 = <span class="string">&quot;val1&quot;</span>, key2 = <span class="string">&quot;val2&quot;</span>, <span class="string">&quot;val3&quot;</span> &#125;</span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(tab1) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k .. <span class="string">&quot; - &quot;</span> .. v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">tab1.key1 = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(tab1) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k .. <span class="string">&quot; - &quot;</span> .. v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>boolean</p>
<p>boolean 类型只有两个可选值：true 和 false，Lua 把 false 和 nil 看作是 false，其他的都为 true，数字 0 也是 true</p>
</li>
<li><p>number</p>
<p>Lua 默认只有一种 number 类型 – double 类型</p>
</li>
<li><p>string</p>
<p>字符串由一对双引号或单引号来表示，也可以用 2 个方括号 “[[]]” 来表示”一块”字符串</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">string1 = <span class="string">&quot;this is string1&quot;</span></span><br><span class="line">string2 = <span class="string">&#x27;this is string2&#x27;</span></span><br><span class="line"></span><br><span class="line">html = <span class="string">[[</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;a href=&quot;http://www.runoob.com/&quot;&gt;菜鸟教程&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">]]</span></span><br></pre></td></tr></table></figure>

<p>在对一个数字字符串上进行算术操作时，Lua 会尝试将这个数字字符串转成一个数字：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; print(&quot;2&quot; + 6)</span><br><span class="line">8.0</span><br><span class="line">&gt; print(&quot;2&quot; + &quot;6&quot;)</span><br><span class="line">8.0</span><br><span class="line">&gt; print(&quot;2 + 6&quot;)</span><br><span class="line">2 + 6</span><br><span class="line">&gt; print(&quot;-2e2&quot; * &quot;6&quot;)</span><br><span class="line">-1200.0</span><br><span class="line">&gt; print(&quot;error&quot; + 1)</span><br><span class="line">stdin:1: attempt to perform arithmetic on a string value</span><br><span class="line">stack traceback:</span><br><span class="line">        stdin:1: in main chunk</span><br><span class="line">        [C]: in ?</span><br></pre></td></tr></table></figure>

<p>字符串连接使用的是 .. ，使用 # 来计算字符串的长度，放在字符串前面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; print(&quot;a&quot; .. &#x27;b&#x27;)</span><br><span class="line">ab</span><br><span class="line">&gt; print(157 .. 428)</span><br><span class="line">157428</span><br><span class="line"></span><br><span class="line">&gt; len = &quot;www.runoob.com&quot;</span><br><span class="line">&gt; print(#len)</span><br><span class="line">14</span><br><span class="line">&gt; print(#&quot;www.runoob.com&quot;)</span><br><span class="line">14</span><br></pre></td></tr></table></figure>
</li>
<li><p>table</p>
<p>在 Lua 里，table 的创建是通过”构造表达式”来完成，最简单构造表达式是{}，用来创建一个空表。也可以在表里添加一些数据，直接初始化表:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建一个空的 table</span></span><br><span class="line"><span class="keyword">local</span> tbl1 = &#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 直接初始表</span></span><br><span class="line"><span class="keyword">local</span> tbl2 = &#123;<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;pear&quot;</span>, <span class="string">&quot;orange&quot;</span>, <span class="string">&quot;grape&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>不同于其他语言的数组把 0 作为数组的初始索引，在 Lua 里表的默认初始索引一般以 1 开始</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- table_test2.lua 脚本文件</span></span><br><span class="line"><span class="keyword">local</span> tbl = &#123;<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;pear&quot;</span>, <span class="string">&quot;orange&quot;</span>, <span class="string">&quot;grape&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> key, val <span class="keyword">in</span> <span class="built_in">pairs</span>(tbl) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Key&quot;</span>, key)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Key    1</span><br><span class="line">Key    2</span><br><span class="line">Key    3</span><br><span class="line">Key    4</span><br></pre></td></tr></table></figure>

<p>table 不会固定长度大小，有新数据添加时 table 长度会自动增长，没初始的 table 都是 nil</p>
</li>
<li><p>function</p>
<p>在 Lua 中，函数是被看作是第一类值，函数可以存在变量里:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- function_test.lua 脚本文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial1</span><span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n * factorial1(n - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(factorial1(<span class="number">5</span>))</span><br><span class="line">factorial2 = factorial1</span><br><span class="line"><span class="built_in">print</span>(factorial2(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

<p>function 可以以匿名函数的方式通过参数传递:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- function_test2.lua 脚本文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testFun</span><span class="params">(tab,fun)</span></span></span><br><span class="line">        <span class="keyword">for</span> k ,v <span class="keyword">in</span> <span class="built_in">pairs</span>(tab) <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">print</span>(fun(k,v));</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tab=&#123;key1=<span class="string">&quot;val1&quot;</span>,key2=<span class="string">&quot;val2&quot;</span>&#125;;</span><br><span class="line">testFun(tab,</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">(key,val)</span></span><span class="comment">--匿名函数</span></span><br><span class="line">        <span class="keyword">return</span> key..<span class="string">&quot;=&quot;</span>..val;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>thread</p>
<p>在 Lua 里，最主要的线程是协同程序（coroutine）。它跟线程（thread）差不多，拥有自己独立的栈、局部变量和指令指针，可以跟其他协同程序共享全局变量和其他大部分东西</p>
<p>线程跟协程的区别：线程可以同时多个运行，而协程任意时刻只能运行一个，并且处于运行状态的协程只有被挂起（suspend）时才会暂停</p>
</li>
<li><p>userdata</p>
<p>userdata 是一种用户自定义数据，用于表示一种由应用程序或 C&#x2F;C++ 语言库所创建的类型，可以将任意 C&#x2F;C++ 的任意数据类型的数据（通常是 struct 和 指针）存储到 Lua 变量中调用</p>
</li>
</ul>
<hr>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>变量在使用前，需要在代码中进行声明，即创建该变量</p>
<p>编译程序执行代码之前编译器需要知道如何给语句变量开辟存储区，用于存储变量的值</p>
<p>Lua 变量有三种类型：全局变量、局部变量、表中的域</p>
<p>Lua 中的变量全是全局变量，哪怕是语句块或是函数里，除非用 local 显式声明为局部变量</p>
<p>局部变量的作用域为从声明位置开始到所在语句块结束</p>
<p>变量的默认值均为 nil</p>
<p><strong>赋值语句</strong></p>
<p>赋值是改变一个变量的值和改变表域的最基本的方法</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;hello&quot;</span> .. <span class="string">&quot;world&quot;</span></span><br><span class="line">t.n = t.n + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>Lua 可以对多个变量同时赋值，变量列表和值列表的各个元素用逗号分开，赋值语句右边的值会依次赋给左边的变量</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a, b = <span class="number">10</span>, <span class="number">2</span>*x       &lt;<span class="comment">--&gt;       a=10; b=2*x</span></span><br></pre></td></tr></table></figure>

<p>遇到赋值语句 Lua 会先计算右边所有的值然后再执行赋值操作，所以我们可以这样进行交换变量的值：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x, y = y, x                     <span class="comment">-- swap &#x27;x&#x27; for &#x27;y&#x27;</span></span><br><span class="line">a[i], a[j] = a[j], a[i]         <span class="comment">-- swap &#x27;a[i]&#x27; for &#x27;a[j]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>当变量个数和值的个数不一致时，Lua 会一直以变量个数为基础采取以下策略：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a. 变量个数 &gt; 值的个数             按变量个数补足nil</span><br><span class="line">b. 变量个数 &lt; 值的个数             多余的值会被忽略</span><br></pre></td></tr></table></figure>

<p>多值赋值经常用来交换变量，或将函数调用返回给变量：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a, b = f()</span><br></pre></td></tr></table></figure>

<p>f() 返回两个值，第一个赋给 a，第二个赋给 b</p>
<p>应该尽可能的使用局部变量，这样既可以避免命名冲突，而且访问局部变量的速度比全局变量更快</p>
<p><strong>索引</strong></p>
<p>对 table 的索引使用方括号 []。Lua 也提供了 . 操作</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t[i]</span><br><span class="line">t.i                 <span class="comment">-- 当索引为字符串类型时的一种简化写法</span></span><br><span class="line">gettable_event(t,i) <span class="comment">-- 采用索引访问本质上是一个类似这样的函数调用</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h2><p>Lua 语言提供了以下几种循环处理方式：</p>
<ul>
<li><p>while 循环</p>
<p>在条件为 true 时，让程序重复地执行某些语句。执行语句前会先检查条件是否为 true</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(condition)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   statements</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>for 循环</p>
<p> 重复执行指定语句，重复次数可在 for 语句中控制</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var=exp1,exp2,exp3 <span class="keyword">do</span>  </span><br><span class="line">    &lt;执行体&gt;  </span><br><span class="line"><span class="keyword">end</span>  </span><br></pre></td></tr></table></figure>

<p>泛型 for 循环通过一个迭代器函数来遍历所有值，类似 java 中的 foreach 语句</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--打印数组a的所有值  </span></span><br><span class="line">a = &#123;<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i, v)</span><br><span class="line"><span class="keyword">end</span> </span><br></pre></td></tr></table></figure>
</li>
<li><p>repeat … until 循环</p>
<p>Lua 编程语言中 repeat…until 循环语句不同于 for 和 while循环，for 和 while 循环的条件语句在当前循环执行开始时判断，而 repeat…until 循环的条件语句在当前循环结束后判断</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">repeat</span></span><br><span class="line">   statements</span><br><span class="line"><span class="keyword">until</span>( condition )</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><p>Lua 提供了以下控制结构语句：</p>
<ul>
<li><p>if 语句</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(布尔表达式)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 在布尔表达式为 true 时执行的语句 --]</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>if … else 语句</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(布尔表达式)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 布尔表达式为 true 时执行该语句块 --]</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="comment">--[ 布尔表达式为 false 时执行该语句块 --]</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>if else if 语句</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (布尔表达式) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 当 (布尔表达式) 为 true 时执行</span></span><br><span class="line"><span class="keyword">elseif</span> (布尔表达式) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 当 condition1 为 false 但 condition2 为 true 时执行</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- 当上面所有条件都为 false 时执行</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><p><strong>算术运算符</strong></p>
<p>设定 A 的值为10，B 的值为 20：</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody><tr>
<td>+</td>
<td>加法</td>
<td>A + B 输出结果 30</td>
</tr>
<tr>
<td>-</td>
<td>减法</td>
<td>A - B 输出结果 -10</td>
</tr>
<tr>
<td>*</td>
<td>乘法</td>
<td>A * B 输出结果 200</td>
</tr>
<tr>
<td>&#x2F;</td>
<td>除法</td>
<td>B &#x2F; A 输出结果 2</td>
</tr>
<tr>
<td>%</td>
<td>取余</td>
<td>B % A 输出结果 0</td>
</tr>
<tr>
<td>^</td>
<td>乘幂</td>
<td>A^2 输出结果 100</td>
</tr>
<tr>
<td>-</td>
<td>负数</td>
<td>-A 输出结果 -10</td>
</tr>
<tr>
<td>&#x2F;&#x2F;</td>
<td>整除运算符（&gt;&#x3D; lua 5.3）</td>
<td>5&#x2F;&#x2F;2 输出结果 2</td>
</tr>
</tbody></table>
<p><strong>关系运算符</strong></p>
<p>设定 A 的值为10，B 的值为 20：</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody><tr>
<td>&#x3D;&#x3D;</td>
<td>等于，检测两个值是否相等，相等返回 true，否则返回 false</td>
<td>(A &#x3D;&#x3D; B) 为 false</td>
</tr>
<tr>
<td>~&#x3D;</td>
<td>不等于，检测两个值是否相等，不相等返回 true，否则返回 false</td>
<td>(A ~&#x3D; B) 为 true</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于，如果左边的值大于右边的值，返回 true，否则返回 false</td>
<td>(A &gt; B) 为 false</td>
</tr>
<tr>
<td>&lt;</td>
<td>小于，如果左边的值大于右边的值，返回 false，否则返回 true</td>
<td>(A &lt; B) 为 true</td>
</tr>
<tr>
<td>&gt;&#x3D;</td>
<td>大于等于，如果左边的值大于等于右边的值，返回 true，否则返回 false</td>
<td>(A &gt;&#x3D; B) 返回 false</td>
</tr>
<tr>
<td>&lt;&#x3D;</td>
<td>小于等于， 如果左边的值小于等于右边的值，返回 true，否则返回 false</td>
<td>(A &lt;&#x3D; B) 返回 true</td>
</tr>
</tbody></table>
<p><strong>逻辑运算符</strong></p>
<p>设定 A 的值为 true，B 的值为 false：</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody><tr>
<td>and</td>
<td>逻辑与操作符。 若 A 为 false，则返回 A，否则返回 B</td>
<td>(A and B) 为 false</td>
</tr>
<tr>
<td>or</td>
<td>逻辑或操作符。 若 A 为 true，则返回 A，否则返回 B</td>
<td>(A or B) 为 true</td>
</tr>
<tr>
<td>not</td>
<td>逻辑非操作符。与逻辑运算结果相反，如果条件为 true，逻辑非为 false</td>
<td>not(A and B) 为 true</td>
</tr>
</tbody></table>
<p><strong>其它运算符</strong></p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody><tr>
<td>..</td>
<td>连接两个字符串</td>
<td>a..b ，其中 a 为 “Hello “ ， b 为 “World”, 输出结果为 “Hello World”</td>
</tr>
<tr>
<td>#</td>
<td>一元运算符，返回字符串或表的长度</td>
<td>#“Hello” 返回 5</td>
</tr>
</tbody></table>
<hr>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p>Lua 语言中字符串可以使用以下三种方式来表示：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 单引号间的一串字符</span></span><br><span class="line"><span class="keyword">local</span> str1 = <span class="string">&#x27;This is a string.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 双引号间的一串字符</span></span><br><span class="line"><span class="keyword">local</span> str2 = <span class="string">&quot;Hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- [[ 与 ]] 间的一串字符</span></span><br><span class="line"><span class="keyword">local</span> multilineString = <span class="string">[[</span></span><br><span class="line"><span class="string">This is a multiline string.</span></span><br><span class="line"><span class="string">It can contain multiple lines of text.</span></span><br><span class="line"><span class="string">No need for escape characters.</span></span><br><span class="line"><span class="string">]]</span></span><br></pre></td></tr></table></figure>



<p><strong>字符串操作</strong></p>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>string.upper(argument)</td>
<td>字符串全部转为大写字母</td>
</tr>
<tr>
<td>string.lower(argument)</td>
<td>字符串全部转为小写字母</td>
</tr>
<tr>
<td>string.gsub(mainString,findString,replaceString,num)</td>
<td>在字符串中替换<br />mainString 为要操作的字符串， findString 为被替换的字符，replaceString 要替换的字符，num 替换次数（可以忽略，则全部替换）</td>
</tr>
<tr>
<td>string.find (str, substr, [init, [plain]])</td>
<td>在一个指定的目标字符串 str 中搜索指定的内容 substr，如果找到了一个匹配的子串，就会返回这个子串的起始索引和结束索引，不存在则返回 nil<br />init 指定了搜索的起始位置，默认为 1，可以一个负数，表示从后往前数的字符个数<br />plain 表示是否使用简单模式，默认为 false，true 只做简单的查找子串的操作，false 表示使用使用正则模式匹配</td>
</tr>
<tr>
<td>string.reverse(arg)</td>
<td>字符串反转</td>
</tr>
<tr>
<td>string.format(…)</td>
<td>返回一个类似 printf 的格式化字符串</td>
</tr>
<tr>
<td>string.char(arg) 和 string.byte(arg[,int])</td>
<td>char 将整型数字转成字符并连接， byte 转换字符为整数值(可以指定某个字符，默认第一个字符)</td>
</tr>
<tr>
<td>string.len(arg)</td>
<td>计算字符串长度，与 # 等价，计算的是字节数而不是字符数</td>
</tr>
<tr>
<td>string.rep(string, n)</td>
<td>返回字符串 string 的 n 个拷贝</td>
</tr>
<tr>
<td>..</td>
<td>链接两个字符串</td>
</tr>
<tr>
<td>string.gmatch(str, pattern)</td>
<td>返回一个迭代器函数，每一次调用这个函数，返回一个在字符串 str 找到的下一个符合 pattern 描述的子串。如果参数 pattern 描述的字符串没有找到，迭代函数返回 nil</td>
</tr>
<tr>
<td>string.match(str, pattern, init)</td>
<td>string.match() 只寻找源字串 str 中的第一个配对. 参数 init 可选, 指定搜寻过程的起点, 默认为 1<br />在成功配对时, 函数将返回配对表达式中的所有捕获结果; 如果没有设置捕获标记, 则返回整个配对字符串. 当没有成功的配对时, 返回 nil</td>
</tr>
</tbody></table>
<hr>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>Lua 中并没有专门的数组类型，而是使用一种被称为 table 的数据结构来实现数组的功能</p>
<p>在 Lua 索引值是以 1 为起始，但也可以指定 0 开始</p>
<p>数组的辑结构是线性表，可以使用索引访问数组元素：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建一个数组</span></span><br><span class="line"><span class="keyword">local</span> myArray = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 访问数组元素</span></span><br><span class="line"><span class="built_in">print</span>(myArray[<span class="number">1</span>])  <span class="comment">-- 输出 10</span></span><br><span class="line"><span class="built_in">print</span>(myArray[<span class="number">3</span>])  <span class="comment">-- 输出 30</span></span><br></pre></td></tr></table></figure>



<p>计算数组的长度（即数组中元素的个数），可以使用 # 操作符：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> myArray = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 计算数组长度</span></span><br><span class="line"><span class="keyword">local</span> length = #myArray</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(length) <span class="comment">-- 输出 5</span></span><br></pre></td></tr></table></figure>



<p>一维数组可以用 for 循环出数组中的元素，lua 索引默认从 1 开始</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建一个数组</span></span><br><span class="line"><span class="keyword">local</span> myArray = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 循环遍历数组</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #myArray <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(myArray[i])</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>在 Lua 中迭代器是一种支持指针类型的结构，它可以遍历集合的每一个元素</p>
<p><strong>泛型 for 迭代器</strong></p>
<p>泛型 for 迭代器提供了集合的 key&#x2F;value 对，语法格式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k, v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">array = &#123;<span class="string">&quot;Google&quot;</span>, <span class="string">&quot;Runoob&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key,value <span class="keyword">in</span> <span class="built_in">ipairs</span>(array) </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">print</span>(key, value)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="table"><a href="#table" class="headerlink" title="table"></a>table</h2><p>table 是 Lua 的一种数据结构用来帮助我们创建不同的数据类型，如：数组、字典等</p>
<p>Lua table 使用关联型数组，可以用任意类型的值来作数组的索引，但这个值不能是 nil</p>
<p>Lua table 是不固定大小的，可以根据自己需要进行扩容</p>
<p>Lua 也是通过 table 来解决模块（module）、包（package）和对象（Object）的。 例如 string.format 表示使用 “format” 来索引 table string</p>
<p>构造器是创建和初始化表的表达式。表是 Lua 特有的功能强大的东西。最简单的构造函数是 {}，用来创建一个空表。可以直接初始化数组：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 初始化表</span></span><br><span class="line">mytable = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 指定值</span></span><br><span class="line">mytable[<span class="number">1</span>]= <span class="string">&quot;Lua&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 移除引用</span></span><br><span class="line">mytable = <span class="literal">nil</span></span><br><span class="line"><span class="comment">-- lua 垃圾回收会释放内存</span></span><br></pre></td></tr></table></figure>



<p><strong>常用方法</strong></p>
<ul>
<li><p>table.concat (table [, sep [, start [, end]]]):</p>
<p>concat 是 concatenate(连锁, 连接)的缩写. table.concat() 函数列出参数中指定 table 的数组部分从 start 位置到 end 位置的所有元素, 元素间以指定的分隔符 (sep) 隔开</p>
</li>
<li><p>table.insert (table, [pos,] value):</p>
<p>在 table 的数组部分指定位置 (pos) 插入值为 value 的一个元素. pos 参数可选, 默认为数组部分末尾</p>
</li>
<li><p>table.remove (table [, pos])</p>
<p>返回 table 数组部分位于 pos 位置的元素. 其后的元素会被前移. pos 参数可选, 默认为 table 长度, 即从最后一个元素删起</p>
</li>
<li><p>table.sort (table [, comp])</p>
<p>对给定的 table 进行升序排序</p>
</li>
</ul>
<hr>
<h2 id="模块和包"><a href="#模块和包" class="headerlink" title="模块和包"></a>模块和包</h2><p><strong>声明</strong></p>
<p>模块类似于一个封装库，从 Lua 5.1 开始，Lua 加入了标准的模块管理机制，可以把一些公用的代码放在一个文件里，以 API 接口的形式在其他地方调用，有利于代码的重用和降低代码耦合度</p>
<p>Lua 的模块是由变量、函数等已知元素组成的 table，因此创建一个模块很简单，就是创建一个 table，然后把需要导出的常量、函数放入其中，最后返回这个 table 就行。以下为创建自定义模块 module.lua，文件代码格式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 文件名为 module.lua</span></span><br><span class="line"><span class="comment">-- 定义一个名为 module 的模块</span></span><br><span class="line"><span class="built_in">module</span> = &#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 定义一个常量</span></span><br><span class="line"><span class="built_in">module</span>.constant = <span class="string">&quot;这是一个常量&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 定义一个函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">module.func1</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;这是一个公有函数！\n&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func2</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;这是一个私有函数！&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">module.func3</span><span class="params">()</span></span></span><br><span class="line">    func2()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> <span class="built_in">module</span></span><br></pre></td></tr></table></figure>

<p>由上可知，模块的结构就是一个 table 的结构，因此可以像操作调用 table 里的元素那样来操作调用模块里的常量或函数</p>
<p>上面的 func2 声明为程序块的局部变量，即表示一个私有函数，因此是不能从外部访问模块里的这个私有函数，必须通过模块里的公有函数来调用</p>
<p><strong>引入</strong></p>
<p>Lua 提供了一个名为 require 的函数用来加载模块。要加载一个模块，只需要简单地调用就可以了。例如：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;&lt;模块名&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或者</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">&quot;&lt;模块名&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<p>也可以给加载的模块定义一个别名变量，方便调用：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- test_module2.lua 文件</span></span><br><span class="line"><span class="comment">-- module 模块为上文提到到 module.lua</span></span><br><span class="line"><span class="comment">-- 别名变量 m</span></span><br><span class="line"><span class="keyword">local</span> m = <span class="built_in">require</span>(<span class="string">&quot;module&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(m.constant)</span><br><span class="line"> </span><br><span class="line">m.func3()</span><br></pre></td></tr></table></figure>



<p><strong>加载机制</strong></p>
<p>对于自定义的模块，模块文件不是放在哪个文件目录都行，函数 require 有它自己的文件路径加载策略，它会尝试从 Lua 文件或 C 程序库中加载模块</p>
<p>require 用于搜索 Lua 文件的路径是存放在全局变量 package.path 中，当 Lua 启动后，会以环境变量 LUA_PATH 的值来初始这个环境变量。如果没有找到该环境变量，则使用一个编译时定义的默认路径来初始化</p>
<p>文件路径以 “;” 号分隔，最后的 2 个 “;;” 表示新加的路径后面加上原来的默认路径</p>
<p>假设 package.path 的值是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/dengjoe/lua/?.lua;./?.lua;/usr/local/share/lua/5.1/?.lua;/usr/local/share/lua/5.1/?/init.lua;/usr/local/lib/lua/5.1/?.lua;/usr/local/lib/lua/5.1/?/init.lua</span><br></pre></td></tr></table></figure>

<p>那么调用 require(“module”) 时就会尝试打开以下文件目录去搜索目标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/Users/dengjoe/lua/module.lua;</span><br><span class="line">./module.lua</span><br><span class="line">/usr/local/share/lua/5.1/module.lua</span><br><span class="line">/usr/local/share/lua/5.1/module/init.lua</span><br><span class="line">/usr/local/lib/lua/5.1/module.lua</span><br><span class="line">/usr/local/lib/lua/5.1/module/init.lua</span><br></pre></td></tr></table></figure>

<p>如果找过目标文件，则会调用 package.loadfile 来加载模块。否则，就会去找 C 程序库</p>
<p><strong>C 包</strong></p>
<p>Lua 和 C 是很容易结合的，使用 C 为 Lua 写包</p>
<p>与 Lua 中写包不同，C 包在使用以前必须首先加载并连接，在大多数系统中最容易的实现方式是通过动态连接库机制</p>
<p>Lua 在一个叫 loadlib 的函数内提供了所有的动态连接的功能。这个函数有两个参数: 库的绝对路径和初始化函数。所以典型的调用的例子如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">path</span> = <span class="string">&quot;/usr/local/lua/lib/libluasocket.so&quot;</span></span><br><span class="line"><span class="keyword">local</span> f = <span class="built_in">loadlib</span>(<span class="built_in">path</span>, <span class="string">&quot;luaopen_socket&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>loadlib 函数加载指定的库并且连接到 Lua，然而它并不打开库（也就是说没有调用初始化函数），反之他返回初始化函数作为 Lua 的一个函数，这样我们就可以直接在 Lua 中调用他</p>
<p>如果加载动态库或者查找初始化函数时出错，loadlib 将返回 nil 和错误信息。可以修改前面一段代码，使其检测错误然后调用初始化函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">path</span> = <span class="string">&quot;/usr/local/lua/lib/libluasocket.so&quot;</span></span><br><span class="line"><span class="comment">-- 或者 path = &quot;C:\\windows\\luasocket.dll&quot;，这是 Window 平台下</span></span><br><span class="line"><span class="keyword">local</span> f = <span class="built_in">assert</span>(<span class="built_in">loadlib</span>(<span class="built_in">path</span>, <span class="string">&quot;luaopen_socket&quot;</span>))</span><br><span class="line">f()  <span class="comment">-- 真正打开库</span></span><br></pre></td></tr></table></figure>

<p>一般情况下我们期望二进制的发布库包含一个与前面代码段相似的 stub 文件，安装二进制库的时候可以随便放在某个目录，只需要修改 stub 文件对应二进制库的实际路径即可</p>
<p>将 stub 文件所在的目录加入到 LUA_PATH，这样设定后就可以使用 require 函数加载 C 库了</p>
<hr>
<h2 id="协同程序"><a href="#协同程序" class="headerlink" title="协同程序"></a>协同程序</h2><p>Lua 协同程序 (coroutine) 与线程比较类似：拥有独立的堆栈，独立的局部变量，独立的指令指针，同时又与其它协同程序共享全局变量和其它大部分东西</p>
<p>协同程序可以理解为一种特殊的线程，可以暂停和恢复其执行，从而允许非抢占式的多任务处理</p>
<p>协同是非常强大的功能，但是用起来也很复杂</p>
<p><strong>基本语法</strong></p>
<p>协同程序由 coroutine 模块提供支持</p>
<p>使用协同程序，你可以在函数中使用 coroutine.create 创建一个新的协同程序对象，并使用 coroutine.resume 启动它的执行。协同程序可以通过调用 coroutine.yield 来主动暂停自己的执行，并将控制权交还给调用者</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>coroutine.create()</td>
<td>创建 coroutine，返回 coroutine， 参数是一个函数，当和 resume 配合使用的时候就唤醒函数调用</td>
</tr>
<tr>
<td>coroutine.resume()</td>
<td>重启 coroutine，和 create 配合使用</td>
</tr>
<tr>
<td>coroutine.yield()</td>
<td>挂起 coroutine，将 coroutine 设置为挂起状态，这个和 resume 配合使用能有很多有用的效果</td>
</tr>
<tr>
<td>coroutine.status()</td>
<td>查看 coroutine 的状态，coroutine 的状态有三种：dead，suspended，running</td>
</tr>
<tr>
<td>coroutine.wrap()</td>
<td>创建 coroutine，返回一个函数，一旦你调用这个函数，就进入 coroutine，和 create 功能重复</td>
</tr>
<tr>
<td>coroutine.running()</td>
<td>返回正在跑的 coroutine，一个 coroutine 就是一个线程，当使用 running 的时候，就是返回一个 coroutine 的线程号</td>
</tr>
</tbody></table>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建了一个新的协同程序对象 co，其中协同程序函数打印传入的参数 i</span></span><br><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(</span><br><span class="line">    <span class="function"><span class="keyword">function</span><span class="params">(i)</span></span></span><br><span class="line">        <span class="built_in">print</span>(i);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">-- 使用 coroutine.resume 启动协同程序 co 的执行，并传入参数 1。协同程序开始执行，打印输出为 1</span></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co, <span class="number">1</span>)   <span class="comment">-- 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 通过 coroutine.status 检查协同程序 co 的状态，输出为 dead，表示协同程序已经执行完毕</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">status</span>(co))  <span class="comment">-- dead</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 coroutine.wrap 创建了一个协同程序包装器，将协同程序函数转换为一个可直接调用的函数对象</span></span><br><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">wrap</span>(</span><br><span class="line">    <span class="function"><span class="keyword">function</span><span class="params">(i)</span></span></span><br><span class="line">        <span class="built_in">print</span>(i);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line">co(<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>)</span><br><span class="line"><span class="comment">-- 创建了另一个协同程序对象 co2，其中的协同程序函数通过循环打印数字 1 到 10，在循环到 3 的时候输出当前协同程序的状态和正在运行的线程</span></span><br><span class="line">co2 = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(</span><br><span class="line">    <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">print</span>(i)</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">status</span>(co2))  <span class="comment">--running</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">running</span>()) <span class="comment">--thread:XXXXXX</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">coroutine</span>.<span class="built_in">yield</span>()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 连续调用 coroutine.resume 启动协同程序 co2 的执行</span></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co2) <span class="comment">--1</span></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co2) <span class="comment">--2</span></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co2) <span class="comment">--3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 通过 coroutine.status 检查协同程序 co2 的状态，输出为 suspended，表示协同程序暂停执行</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">status</span>(co2))   <span class="comment">-- suspended</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">running</span>())</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>)</span><br></pre></td></tr></table></figure>



<p><strong>线程和协同程序的区别</strong></p>
<p>线程与协同程序的主要区别在于，一个具有多个线程的程序可以同时运行几个线程，而协同程序却需要彼此协作的运行。在任一指定时刻只有一个协同程序在运行，并且这个正在运行的协同程序只有在明确的被要求挂起的时候才会被挂起。协同程序有点类似同步的多线程，在等待同一个线程锁的几个线程有点类似协同</p>
<p>主要区别归纳如下：</p>
<ul>
<li>调度方式：线程通常由操作系统的调度器进行抢占式调度，操作系统会在不同线程之间切换执行权。而协同程序是非抢占式调度的，它们由程序员显式地控制执行权的转移</li>
<li>并发性：线程是并发执行的，多个线程可以同时运行在多个处理器核心上，或者通过时间片轮转在单个核心上切换执行。协同程序则是协作式的，只有一个协同程序处于运行状态，其他协同程序必须等待当前协同程序主动放弃执行权</li>
<li>内存占用：线程通常需要独立的堆栈和上下文环境，因此线程的创建和销毁会带来额外的开销。而协同程序可以共享相同的堆栈和上下文，因此创建和销毁协同程序的开销较小</li>
<li>数据共享：线程之间可以共享内存空间，但需要注意线程安全性和同步问题。协同程序通常通过参数传递和返回值来进行数据共享，不同协同程序之间的数据隔离性较好</li>
<li>调试和错误处理：线程通常在调试和错误处理方面更复杂，因为多个线程之间的交互和并发执行可能导致难以调试的问题。协同程序则在调试和错误处理方面相对简单，因为它们是由程序员显式地控制执行流程的</li>
</ul>
<p>总体而言，线程适用于需要并发执行的场景，例如在多核处理器上利用并行性加快任务的执行速度。而协同程序适用于需要协作和协调的场景，例如状态机、事件驱动编程或协作式任务处理。选择使用线程还是协同程序取决于具体的应用需求和编程模型</p>
<hr>
<h2 id="文件-I-O"><a href="#文件-I-O" class="headerlink" title="文件 I&#x2F;O"></a>文件 I&#x2F;O</h2><p>Lua I&#x2F;O 库用于读取和处理文件。分为简单模式（和 C 一样）、完全模式</p>
<ul>
<li>简单模式（simple model）拥有一个当前输入文件和一个当前输出文件，并且提供针对这些文件相关的操作</li>
<li>完全模式（complete model） 使用外部的文件句柄来实现。它以一种面对对象的形式，将所有的文件操作定义为文件句柄的方法</li>
</ul>
<p>简单模式在做一些简单的文件操作时较为合适。但是在进行一些高级的文件操作的时候，简单模式就显得力不从心。例如同时读取多个文件这样的操作，使用完全模式则较为合适</p>
<p><strong>打开文件</strong></p>
<p>打开文件操作语句如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file = <span class="built_in">io</span>.<span class="built_in">open</span> (filename [, mode])</span><br></pre></td></tr></table></figure>



<p>mode 的值有：</p>
<table>
<thead>
<tr>
<th>模式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>r</td>
<td>以只读方式打开文件，该文件必须存在</td>
</tr>
<tr>
<td>w</td>
<td>打开只写文件，若文件存在则文件长度清为 0，即该文件内容会消失。若文件不存在则建立该文件</td>
</tr>
<tr>
<td>a</td>
<td>以附加的方式打开只写文件。若文件不存在，则会建立该文件，如果文件存在，写入的数据会被加到文件尾，即文件原先的内容会被保留。（EOF符保留）</td>
</tr>
<tr>
<td>r+</td>
<td>以可读写方式打开文件，该文件必须存在</td>
</tr>
<tr>
<td>w+</td>
<td>打开可读写文件，若文件存在则文件长度清为零，即该文件内容会消失。若文件不存在则建立该文件</td>
</tr>
<tr>
<td>a+</td>
<td>与 a 类似，但此文件可读可写</td>
</tr>
<tr>
<td>b</td>
<td>二进制模式，如果文件是二进制文件，可以加上 b</td>
</tr>
<tr>
<td>+</td>
<td>表示对文件既可以读也可以写</td>
</tr>
</tbody></table>
<p><strong>简单模式</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 以只读方式打开文件</span></span><br><span class="line">file = <span class="built_in">io</span>.<span class="built_in">open</span>(<span class="string">&quot;test.lua&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置默认输入文件为 test.lua</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>(file)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出文件第一行</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">io</span>.<span class="built_in">read</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭打开的文件</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">close</span>(file)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 以附加的方式打开只写文件</span></span><br><span class="line">file = <span class="built_in">io</span>.<span class="built_in">open</span>(<span class="string">&quot;test.lua&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置默认输出文件为 test.lua</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">output</span>(file)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在文件最后一行添加 Lua 注释</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;--  test.lua 文件末尾注释&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭打开的文件</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">close</span>(file)</span><br></pre></td></tr></table></figure>

<p>输出了 test.lua 文件的第一行信息，并在该文件最后一行添加了 lua 的注释</p>
<p><strong>完全模式</strong></p>
<p>通常需要在同一时间处理多个文件。我们需要使用 file:function_name 来代替 io.function_name 方法。以下实例演示了如何同时处理同一个文件:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 以只读方式打开文件</span></span><br><span class="line">file = <span class="built_in">io</span>.<span class="built_in">open</span>(<span class="string">&quot;test.lua&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出文件第一行</span></span><br><span class="line"><span class="built_in">print</span>(file:<span class="built_in">read</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭打开的文件</span></span><br><span class="line">file:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 以附加的方式打开只写文件</span></span><br><span class="line">file = <span class="built_in">io</span>.<span class="built_in">open</span>(<span class="string">&quot;test.lua&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在文件最后一行添加 Lua 注释</span></span><br><span class="line">file:<span class="built_in">write</span>(<span class="string">&quot;--test&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭打开的文件</span></span><br><span class="line">file:<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>程序运行中错误处理是必要的，在我们进行文件操作，数据转移及 web service 调用过程中都会出现不可预期的错误。如果不注重错误信息的处理，就会造成信息泄露，程序无法运行等情况</p>
<p>任何程序语言中，都需要错误处理。错误类型有语法错误和运行错误。语法错误处理起来很简单，只需要改成正确的语法就行了</p>
<p>可以使用两个函数：assert 和 error 来处理错误。实例如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(a,b)</span></span></span><br><span class="line">   <span class="built_in">assert</span>(<span class="built_in">type</span>(a) == <span class="string">&quot;number&quot;</span>, <span class="string">&quot;a 不是一个数字&quot;</span>)</span><br><span class="line">   <span class="built_in">assert</span>(<span class="built_in">type</span>(b) == <span class="string">&quot;number&quot;</span>, <span class="string">&quot;b 不是一个数字&quot;</span>)</span><br><span class="line">   <span class="keyword">return</span> a+b</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">add(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>执行以上程序会出现如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lua: test.lua:3: b 不是一个数字</span><br><span class="line">stack traceback:</span><br><span class="line">    [C]: in function &#x27;assert&#x27;</span><br><span class="line">    test.lua:3: in local &#x27;add&#x27;</span><br><span class="line">    test.lua:6: in main chunk</span><br><span class="line">    [C]: in ?</span><br></pre></td></tr></table></figure>

<p>实例中 assert 首先检查第一个参数，若没问题，assert 不做任何事情；否则，assert 以第二个参数作为错误信息抛出</p>
<p>Lua 中处理错误，可以使用函数 pcall（protected call）来包装需要执行的代码</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">pcall</span>(function_name, ….) <span class="keyword">then</span></span><br><span class="line"><span class="comment">-- 没有错误</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment">-- 一些错误</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>Lua 采用了自动内存管理。 这意味着不用操心新创建的对象需要的内存如何分配出来， 也不用考虑在对象不再被使用后怎样释放它们所占用的内存</p>
<p>Lua 运行了一个垃圾收集器来收集所有死对象 （即在 Lua 中不可能再访问到的对象）来完成自动内存管理的工作。 Lua 中所有用到的内存，如：字符串、表、用户数据、函数、线程、 内部结构等，都服从自动管理</p>
<p>Lua 实现了一个增量标记 - 扫描收集器。 它使用这两个数字来控制垃圾收集循环： 垃圾收集器间歇率和垃圾收集器步进倍率。 这两个数字都使用百分数为单位 （例如：值 100 在内部表示 1 ）</p>
<p>垃圾收集器间歇率控制着收集器需要在开启新的循环前要等待多久。 增大这个值会减少收集器的积极性。 当这个值比 100 小的时候，收集器在开启新的循环前不会有等待。 设置这个值为 200 就会让收集器等到总内存使用量达到之前的两倍时才开始新的循环</p>
<p>垃圾收集器步进倍率控制着收集器运作速度相对于内存分配速度的倍率。 增大这个值不仅会让收集器更加积极，还会增加每个增量步骤的长度。 不要把这个值设得小于 100 ， 那样的话收集器就工作的太慢了以至于永远都干不完一个循环。 默认值是 200 ，这表示收集器以内存分配的 “两倍” 速工作</p>
<p>如果你把步进倍率设为一个非常大的数字 （比你的程序可能用到的字节数还大 10% ）， 收集器的行为就像一个 stop-the-world 收集器。 接着你若把间歇率设为 200 ， 收集器的行为就和过去的 Lua 版本一样了： 每次 Lua 使用的内存翻倍时，就做一次完整的收集</p>
<hr>
<h2 id="Nginx-Lua-MySQL"><a href="#Nginx-Lua-MySQL" class="headerlink" title="Nginx + Lua + MySQL"></a>Nginx + Lua + MySQL</h2><ol>
<li><p>安装插件</p>
<p>Lua 提供的一些基础函数实现了对字符串、IO 流、日期等数据的操作，如果想实现更多的功能，则需要安装一些插件，比如此次案例中需要用到的 cjson 插件和 resty.mysql 插件</p>
<p>OpenResty(又称：ngx_openresty) 是一个基于 NGINX 的可伸缩的 Web 平台，由中国人章亦春发起，提供了很多高质量的第三方模块</p>
<p>因为 OpenResty 中已经集成了 cjson 和 resty.mysql 插件，所以我们安装 OpenResty 即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://openresty.org/download/ngx_openresty-1.9.7.1.tar.gz   <span class="comment"># 下载</span></span><br><span class="line">tar xzvf ngx_openresty-1.9.7.1.tar.gz       <span class="comment"># 解压</span></span><br><span class="line"><span class="built_in">cd</span> ngx_openresty-1.9.7.1/ </span><br><span class="line">./configure</span><br><span class="line">make </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写 Lua 脚本</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 指定输出的文件类型为 JSON</span></span><br><span class="line">ngx.header.content_type = <span class="string">&quot;application/json;charset=utf-8&quot;</span></span><br><span class="line"><span class="comment">-- 引入库文件 JSON</span></span><br><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">&quot;cjson&quot;</span></span><br><span class="line"><span class="comment">-- 引入依赖库 mysql</span></span><br><span class="line"><span class="keyword">local</span> mysql = <span class="built_in">require</span> <span class="string">&quot;resty.mysql&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 配置数据库连接信息</span></span><br><span class="line"><span class="keyword">local</span> props = &#123;</span><br><span class="line">    host = <span class="string">&quot;数据库地址&quot;</span>，</span><br><span class="line">    port = <span class="number">3306</span>,</span><br><span class="line">    database = <span class="string">&quot;数据库名&quot;</span>，</span><br><span class="line">    user = <span class="string">&quot;用户名&quot;</span>,</span><br><span class="line">    password = <span class="string">&quot;用户密码&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建连接，设置超时时间和编码格式</span></span><br><span class="line"><span class="keyword">local</span> db = mysql:new()</span><br><span class="line">db:set_timeout(<span class="number">10000</span>)</span><br><span class="line">db:connect(props)</span><br><span class="line">db:query(<span class="string">&quot;SET NAMES utf8&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- SQL 语句</span></span><br><span class="line"><span class="keyword">local</span> id = ngx.req.get_uri_args()[<span class="string">&quot;id&quot;</span>] <span class="comment">-- 从请求路径中获得的参数</span></span><br><span class="line"><span class="keyword">local</span> sql = <span class="string">&quot;SELECT * FROM userinfo WHERE id = &quot;</span> ..id</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行 SQL 语句</span></span><br><span class="line"><span class="keyword">local</span> result = db:query(sql)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭连接</span></span><br><span class="line">db:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将响应结果以 JSON 的方式返回</span></span><br><span class="line">ngx.sqy(cjson.encode(result))</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 Nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-- 在 Nginx 添加如下配置</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	# 执行 Lua 脚本</span><br><span class="line">	location /mysql &#123;</span><br><span class="line">		content_by_lua_file &quot;Lua文件全路径&quot;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问地址</p>
<p>接下来，在浏览器中访问 <a target="_blank" rel="noopener" href="http://nginx地址/mysql?id=1">http://nginx地址/mysql?id=1</a> 即可</p>
<p><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/image-20230530001918657.png" alt="image-20230530001918657"></p>
</li>
</ol>
<hr>
<h2 id="SpringBoot-Redis-Lua-实现扣减库存"><a href="#SpringBoot-Redis-Lua-实现扣减库存" class="headerlink" title="SpringBoot + Redis + Lua 实现扣减库存"></a>SpringBoot + Redis + Lua 实现扣减库存</h2><ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写 Lua 脚本</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- second.lua</span></span><br><span class="line"><span class="comment">-- 从传入的参数数组中取出参数</span></span><br><span class="line"><span class="keyword">local</span> stockKey = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">--商品购买用户记录Key product_buyers_XXX</span></span><br><span class="line"><span class="keyword">local</span> buyersKey = KEYS[<span class="number">2</span>]</span><br><span class="line"><span class="comment">--用户ID</span></span><br><span class="line"><span class="keyword">local</span> uid = KEYS[<span class="number">3</span>]</span><br><span class="line"><span class="comment">--校验用户是否已经购买</span></span><br><span class="line"><span class="keyword">local</span> result=redis.call(<span class="string">&quot;sadd&quot;</span> , buyersKey , uid )</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(result)==<span class="number">1</span>)</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">    <span class="comment">--没有购买过，可以购买</span></span><br><span class="line">    <span class="keyword">local</span> stock=redis.call(<span class="string">&quot;lpop&quot;</span> , stockKey )</span><br><span class="line">    <span class="comment">--除了nil和false，其他值都是真（包括0）</span></span><br><span class="line">    <span class="keyword">if</span>(stock)</span><br><span class="line">    <span class="keyword">then</span> </span><br><span class="line">        <span class="comment">--有库存</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">--没有库存</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">--已经购买过</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-3</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>RedisLuaUtil 工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisLuaUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">runLuaScript</span><span class="params">(String luaFileName,List&lt;String&gt; keyList)</span> &#123;</span><br><span class="line">		<span class="comment">// Lua 脚本路径</span></span><br><span class="line">        DefaultRedisScript&lt;String&gt; redisScript = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        redisScript.setScriptSource(<span class="keyword">new</span> <span class="title class_">ResourceScriptSource</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/&quot;</span>+luaFileName)));</span><br><span class="line">		<span class="comment">// 脚本执行返回参数类型</span></span><br><span class="line">        redisScript.setResultType(Integer.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">argsone</span> <span class="operator">=</span> <span class="string">&quot;none&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = stringRedisTemplate.execute(redisScript, keyList,argsone);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;发生异常&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用 Util 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">skuSecond</span><span class="params">(String actId,String userId,<span class="type">int</span> buyNum,String skuId,<span class="type">int</span> perSkuLim,<span class="type">int</span> perActLim)</span> &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//时间字串，用来区分秒杀成功的订单</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">START</span> <span class="operator">=</span> <span class="number">100000</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">END</span> <span class="operator">=</span> <span class="number">900000</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">rand_num</span> <span class="operator">=</span> ThreadLocalRandom.current().nextInt(END - START + <span class="number">1</span>) + START;</span><br><span class="line">    <span class="type">String</span> <span class="variable">order_time</span> <span class="operator">=</span> TimeUtil.getTimeNowStr()+<span class="string">&quot;-&quot;</span>+rand_num;</span><br><span class="line">    List&lt;String&gt; keyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    </span><br><span class="line">    keyList.add(userId);</span><br><span class="line">    keyList.add(String.valueOf(buyNum));</span><br><span class="line">    keyList.add(skuId);</span><br><span class="line">    keyList.add(String.valueOf(perSkuLim));</span><br><span class="line">    keyList.add(actId);</span><br><span class="line">    keyList.add(String.valueOf(perActLim));</span><br><span class="line">    keyList.add(order_time);</span><br><span class="line">   </span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> redisLuaUtil.runLuaScript(<span class="string">&quot;second.lua&quot;</span>,keyList);</span><br><span class="line">    System.out.println(<span class="string">&quot;------------------lua result:&quot;</span>+result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="Lua-扣减库存-风控校验"><a href="#Lua-扣减库存-风控校验" class="headerlink" title="Lua 扣减库存 + 风控校验"></a>Lua 扣减库存 + 风控校验</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 从入参中取得活动 id 和奖品 id，拼接成 Redis Key</span></span><br><span class="line"><span class="keyword">local</span> inventory_redis_key = <span class="string">&#x27;Inventory:&#x27;</span>..KEYS[<span class="number">1</span>]..<span class="string">&#x27;:&#x27;</span>..KEYS[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">local</span> prize_issued_num_key = <span class="string">&#x27;Issued:&#x27;</span>..KEYS[<span class="number">1</span>]..<span class="string">&#x27;:&#x27;</span>..KEYS[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">local</span> total_num = <span class="built_in">tonumber</span>(KEYS[<span class="number">3</span>]);</span><br><span class="line"><span class="comment">-- 查询奖品总库存和每日库存</span></span><br><span class="line"><span class="keyword">local</span> inventory = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, inventory_redis_key))</span><br><span class="line"><span class="keyword">local</span> issued_num = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, prize_issued_num_key))</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 如果没有设置每日库存或每日库存为 0，，则返回库存不足</span></span><br><span class="line"><span class="keyword">if</span> inventory == <span class="literal">nil</span> <span class="keyword">or</span> inventory == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;NO_INVENTORY&#x27;</span></span><br><span class="line"><span class="comment">-- 如果不限日库存，则要求总库存大于已领库存，成功的话对已领库存 +1，并判断是否触发总库存监控</span></span><br><span class="line"><span class="keyword">elseif</span> inventory &lt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> total_num &lt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        redis.call(<span class="string">&#x27;set&#x27;</span>, prize_issued_num_key, <span class="built_in">tostring</span>(issued_num + <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;SUCCESS&#x27;</span></span><br><span class="line">    <span class="keyword">elseif</span> total_num &gt; issued_num <span class="keyword">then</span></span><br><span class="line">        redis.call(<span class="string">&#x27;set&#x27;</span>, prize_issued_num_key, <span class="built_in">tostring</span>(issued_num + <span class="number">1</span>))</span><br><span class="line">        <span class="comment">-- 判断是否触发总库存监控，如果是库存监控触发的最后一个值则触发报警，其余的则触发监控</span></span><br><span class="line">        <span class="keyword">local</span> total_trigger_list_key = <span class="string">&#x27;Monitor:Total:&#x27;</span>..KEYS[<span class="number">1</span>]..<span class="string">&#x27;:&#x27;</span>..KEYS[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">local</span> total_trigger_list = redis.call(<span class="string">&#x27;lrange&#x27;</span>, total_trigger_list_key, <span class="number">0</span>, <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">if</span> total_trigger_list == <span class="literal">nil</span> <span class="keyword">or</span> #total_trigger_list &lt;= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;SUCCESS&#x27;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(total_trigger_list) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> (issued_num + <span class="number">1</span>) == <span class="built_in">tonumber</span>(value)  <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">if</span> index == #total_trigger_list <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&#x27;TOTAL_WARNING&#x27;</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&#x27;TOTAL_MONITOR&#x27;</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;SUCCESS&#x27;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;NO_INVENTORY&#x27;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 如果每日库存受限而总库存不受限，则判断每日库存是否足够，库存足够的话则对已领库存 +1 和每日库存 -1，并判断是否触发每日库存监控</span></span><br><span class="line"><span class="keyword">elseif</span> inventory &gt; <span class="number">0</span> <span class="keyword">and</span> total_num &lt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> inventory &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        redis.call(<span class="string">&#x27;set&#x27;</span>, inventory_redis_key, <span class="built_in">tostring</span>(inventory - <span class="number">1</span>))</span><br><span class="line">        redis.call(<span class="string">&#x27;set&#x27;</span>, prize_issued_num_key, <span class="built_in">tostring</span>(issued_num + <span class="number">1</span>))</span><br><span class="line">        <span class="comment">-- 判断是否触发每日库存监控，如果是库存监控触发的最后一个值则触发报警，其余的则触发监控</span></span><br><span class="line">        <span class="keyword">local</span> daily_trigger_list_key = <span class="string">&#x27;Monitor:Daily:&#x27;</span>..KEYS[<span class="number">1</span>]..<span class="string">&#x27;:&#x27;</span>..KEYS[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">local</span> daily_trigger_list = redis.call(<span class="string">&#x27;lrange&#x27;</span>, daily_trigger_list_key, <span class="number">0</span>, <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">if</span> daily_trigger_list == <span class="literal">nil</span> <span class="keyword">or</span> #daily_trigger_list &lt;= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;SUCCESS&#x27;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(daily_trigger_list) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> (inventory - <span class="number">1</span>) == <span class="built_in">tonumber</span>(value)  <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">if</span> index == #daily_trigger_list <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&#x27;DAILY_WARNING&#x27;</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&#x27;DAILY_MONITOR&#x27;</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;SUCCESS&#x27;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;NO_INVENTORY&#x27;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 如果每日库存和奖品总库存都是不限库存的话，则对已领库存 +1 即可</span></span><br><span class="line"><span class="keyword">elseif</span> inventory &lt; <span class="number">0</span> <span class="keyword">and</span> total_num &lt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;set&#x27;</span>, prize_issued_num_key, <span class="built_in">tostring</span>(issued_num + <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;SUCCESS&#x27;</span></span><br><span class="line">    <span class="comment">-- 如果二者都受限，则判断两个库存是否都足够，库存足够的话则对已领库存 +1 和每日库存 -1，并判断二者是否触发风控</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> inventory &gt; <span class="number">0</span> <span class="keyword">and</span> total_num &gt; issued_num <span class="keyword">then</span></span><br><span class="line">        redis.call(<span class="string">&#x27;set&#x27;</span>, inventory_redis_key, <span class="built_in">tostring</span>(inventory - <span class="number">1</span>))</span><br><span class="line">        redis.call(<span class="string">&#x27;set&#x27;</span>, prize_issued_num_key, <span class="built_in">tostring</span>(issued_num + <span class="number">1</span>))</span><br><span class="line">        <span class="comment">-- 判断是否触发总库存监控，不直接返回值，记录状态</span></span><br><span class="line">        <span class="comment">-- 不触发：0  总库存监控：1  总库存报警：5</span></span><br><span class="line">        <span class="keyword">local</span> total_monitor_status = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">local</span> total_trigger_list_key = <span class="string">&#x27;Monitor:Total:&#x27;</span>..KEYS[<span class="number">1</span>]..<span class="string">&#x27;:&#x27;</span>..KEYS[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">local</span> total_trigger_list = redis.call(<span class="string">&#x27;lrange&#x27;</span>, total_trigger_list_key, <span class="number">0</span>, <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">if</span> total_trigger_list ~= <span class="literal">nil</span> <span class="keyword">and</span> #total_trigger_list &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(total_trigger_list) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> (issued_num + <span class="number">1</span>) == <span class="built_in">tonumber</span>(value)  <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> index == #total_trigger_list <span class="keyword">then</span></span><br><span class="line">                        total_monitor_status = <span class="number">5</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        total_monitor_status = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 判断是否触发每日库存监控，不直接返回值，记录状态</span></span><br><span class="line">        <span class="comment">-- 不触发：0  每日库存监控：2  每日库存报警：9</span></span><br><span class="line">        <span class="keyword">local</span> daily_monitor_status = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">local</span> daily_trigger_list_key = <span class="string">&#x27;Monitor:Daily:&#x27;</span>..KEYS[<span class="number">1</span>]..<span class="string">&#x27;:&#x27;</span>..KEYS[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">local</span> daily_trigger_list = redis.call(<span class="string">&#x27;lrange&#x27;</span>, daily_trigger_list_key, <span class="number">0</span>, <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">if</span> daily_trigger_list ~= <span class="literal">nil</span> <span class="keyword">and</span> #daily_trigger_list &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(daily_trigger_list) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> (inventory - <span class="number">1</span>) == <span class="built_in">tonumber</span>(value)  <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> index == #daily_trigger_list <span class="keyword">then</span></span><br><span class="line">                        daily_monitor_status = <span class="number">9</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        daily_monitor_status = <span class="number">2</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 将两个 monitor_status 相加，根据其值的唯一性来判断触发的监控类型</span></span><br><span class="line">        <span class="keyword">local</span> monitor_status = total_monitor_status + daily_monitor_status</span><br><span class="line">        <span class="keyword">if</span> monitor_status == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;SUCCESS&#x27;</span></span><br><span class="line">        <span class="keyword">elseif</span> monitor_status == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;TOTAL_MONITOR&#x27;</span></span><br><span class="line">        <span class="keyword">elseif</span> monitor_status == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;DAILY_MONITOR&#x27;</span></span><br><span class="line">        <span class="keyword">elseif</span> monitor_status == <span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;TOTAL_MONITOR_AND_DAILY_MONITOR&#x27;</span></span><br><span class="line">        <span class="keyword">elseif</span> monitor_status == <span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;TOTAL_WARNING&#x27;</span></span><br><span class="line">        <span class="keyword">elseif</span> monitor_status == <span class="number">7</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;TOTAL_WARNING_AND_DAILY_MONITOR&#x27;</span></span><br><span class="line">        <span class="keyword">elseif</span> monitor_status == <span class="number">9</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;DAILY_WARNING&#x27;</span></span><br><span class="line">        <span class="keyword">elseif</span> monitor_status == <span class="number">10</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;TOTAL_MONITOR_AND_DAILY_WARNING&#x27;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;TOTAL_WARNING_AND_DAILY_WARNING&#x27;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;NO_INVENTORY&#x27;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://yoursite.com">Simon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2024/10/31/Java/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/">http://yoursite.com/2024/10/31/Java/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">Simon 的书柜</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post_share"><div class="social-share" data-image="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/preview.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/10/02/%E5%89%8D%E7%AB%AF/Node.js%20%E6%95%99%E7%A8%8B/" title="Node.js 教程"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E5%89%8D%E7%AB%AF/Node.js%20%E6%95%99%E7%A8%8B/preview.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Node.js 教程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/03/27/Java/JDBC%20%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%8A%80%E6%9C%AF/" title="JDBC 数据库连接技术"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/JDBC%20%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%8A%80%E6%9C%AF/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-27</div><div class="title">JDBC 数据库连接技术</div></div></a></div><div><a href="/2023/09/01/Java/Java%2011%20%E6%96%B0%E7%89%B9%E6%80%A7/" title="Java 11 新特性"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Java%2011%20%E6%96%B0%E7%89%B9%E6%80%A7/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-01</div><div class="title">Java 11 新特性</div></div></a></div><div><a href="/2023/08/29/Java/Java%2010%20%E6%96%B0%E7%89%B9%E6%80%A7/" title="Java 10 新特性"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Java%2010%20%E6%96%B0%E7%89%B9%E6%80%A7/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-29</div><div class="title">Java 10 新特性</div></div></a></div><div><a href="/2023/08/20/Java/Java%209%20%E6%96%B0%E7%89%B9%E6%80%A7/" title="Java 9 新特性"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Java%209%20%E6%96%B0%E7%89%B9%E6%80%A7/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-20</div><div class="title">Java 9 新特性</div></div></a></div><div><a href="/2023/02/19/Java/Nacos%20%E5%92%8C%20Eureka%20%E7%9A%84%E5%AF%B9%E6%AF%94/" title="Nacos 和 Eureka 的对比"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Nacos%20%E5%92%8C%20Eureka%20%E5%AF%B9%E6%AF%94/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-19</div><div class="title">Nacos 和 Eureka 的对比</div></div></a></div><div><a href="/2023/08/17/Java/Java%208%20%E6%96%B0%E7%89%B9%E6%80%A7/" title="Java 8 新特性"><img class="cover" src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Java%208%20%E6%96%B0%E7%89%B9%E6%80%A7/preview.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-17</div><div class="title">Java 8 新特性</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E8%83%8C%E6%99%AF%E5%9B%BE/v2-bd12bc8dfb61abe313ad48b907c5da94_720w.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Simon</div><div class="author-info__description">攀登亦是风景</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">40</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/CK-shadow" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ck1996shadow@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lua-%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98"><span class="toc-number">1.</span> <span class="toc-text">Lua 脚本实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">环境安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">1.5.</span> <span class="toc-text">变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.6.</span> <span class="toc-text">循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-number">1.7.</span> <span class="toc-text">流程控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">1.8.</span> <span class="toc-text">运算符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.9.</span> <span class="toc-text">字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E7%BB%84"><span class="toc-number">1.10.</span> <span class="toc-text">数组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-number">1.11.</span> <span class="toc-text">迭代器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#table"><span class="toc-number">1.12.</span> <span class="toc-text">table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%92%8C%E5%8C%85"><span class="toc-number">1.13.</span> <span class="toc-text">模块和包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E5%90%8C%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.14.</span> <span class="toc-text">协同程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6-I-O"><span class="toc-number">1.15.</span> <span class="toc-text">文件 I&#x2F;O</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.16.</span> <span class="toc-text">错误处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6"><span class="toc-number">1.17.</span> <span class="toc-text">垃圾回收</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-Lua-MySQL"><span class="toc-number">1.18.</span> <span class="toc-text">Nginx + Lua + MySQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBoot-Redis-Lua-%E5%AE%9E%E7%8E%B0%E6%89%A3%E5%87%8F%E5%BA%93%E5%AD%98"><span class="toc-number">1.19.</span> <span class="toc-text">SpringBoot + Redis + Lua 实现扣减库存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua-%E6%89%A3%E5%87%8F%E5%BA%93%E5%AD%98-%E9%A3%8E%E6%8E%A7%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.20.</span> <span class="toc-text">Lua 扣减库存 + 风控校验</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/10/31/Java/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/" title="Lua 脚本实战"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Lua 脚本实战"/></a><div class="content"><a class="title" href="/2024/10/31/Java/Lua%20%E8%84%9A%E6%9C%AC%E5%AE%9E%E6%88%98/" title="Lua 脚本实战">Lua 脚本实战</a><time datetime="2024-10-31T00:41:19.000Z" title="发表于 2024-10-31 08:41:19">2024-10-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/02/%E5%89%8D%E7%AB%AF/Node.js%20%E6%95%99%E7%A8%8B/" title="Node.js 教程"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E5%89%8D%E7%AB%AF/Node.js%20%E6%95%99%E7%A8%8B/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Node.js 教程"/></a><div class="content"><a class="title" href="/2024/10/02/%E5%89%8D%E7%AB%AF/Node.js%20%E6%95%99%E7%A8%8B/" title="Node.js 教程">Node.js 教程</a><time datetime="2024-10-02T02:06:08.000Z" title="发表于 2024-10-02 10:06:08">2024-10-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/16/Java/Spring%20Cloud%20Alibaba%20%E5%AE%9E%E6%88%98/" title="Spring Cloud Alibaba 实战"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/JAVA/Spring%20Cloud%20Alibaba%20%E5%AE%9E%E6%88%98/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring Cloud Alibaba 实战"/></a><div class="content"><a class="title" href="/2024/09/16/Java/Spring%20Cloud%20Alibaba%20%E5%AE%9E%E6%88%98/" title="Spring Cloud Alibaba 实战">Spring Cloud Alibaba 实战</a><time datetime="2024-09-16T10:10:01.000Z" title="发表于 2024-09-16 18:10:01">2024-09-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/08/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%BC%95%E6%93%8E%20Camunda%207/" title="工作流引擎 Camunda 7"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%BC%95%E6%93%8E%20Camunda%207/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="工作流引擎 Camunda 7"/></a><div class="content"><a class="title" href="/2024/08/10/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%BC%95%E6%93%8E%20Camunda%207/" title="工作流引擎 Camunda 7">工作流引擎 Camunda 7</a><time datetime="2024-08-10T04:59:43.000Z" title="发表于 2024-08-10 12:59:43">2024-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/01/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/RabbitMQ%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98/" title="RabbitMQ 从入门到实战"><img src="https://simon-bookcase.oss-cn-beijing.aliyuncs.com/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/preview.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RabbitMQ 从入门到实战"/></a><div class="content"><a class="title" href="/2024/07/01/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/RabbitMQ%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98/" title="RabbitMQ 从入门到实战">RabbitMQ 从入门到实战</a><time datetime="2024-06-30T19:23:13.000Z" title="发表于 2024-07-01 03:23:13">2024-07-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Simon</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>